<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Farm Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Markdown Parser for AI Responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .gauge-circle-bg { fill: none; stroke: #e5e7eb; stroke-width: 10; }
        .gauge-circle-progress { fill: none; stroke-width: 10; stroke-linecap: round; transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 0.5s ease-in-out; }
        .pulse-animation { animation: pulse-frames 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse-frames { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .icon-picker-item.selected { border-color: #3b82f6; transform: scale(1.1); background-color: #eff6ff; }
        .plant-category-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        
        /* Scrollbar Hide */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Chat UI Improvements */
        .chat-container { display: flex; flex-direction: column; gap: 1rem; }
        
        .chat-message { display: flex; align-items: flex-start; max-width: 80%; margin-bottom: 0; } /* margin-bottom removed as gap handles it */
        .chat-message.user { align-self: flex-end; flex-direction: row-reverse; }
        .chat-message.ai { align-self: flex-start; }

        .chat-avatar { 
            width: 36px; height: 36px; 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .chat-message.user .chat-avatar { margin-left: 8px; background-color: #dbeafe; } /* Light blue for user */
        .chat-message.ai .chat-avatar { margin-right: 8px; background-color: #ffffff; border: 1px solid #e5e7eb; } /* White for AI */

        .chat-bubble { 
            padding: 10px 14px; 
            border-radius: 18px; 
            line-height: 1.5; 
            font-size: 0.95rem; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: relative;
            word-break: break-word;
        }
        
        .chat-message.user .chat-bubble { 
            background-color: #3b82f6; 
            color: white; 
            border-top-right-radius: 4px; 
        }
        
        .chat-message.ai .chat-bubble { 
            background-color: #ffffff; 
            color: #1f2937; 
            border: 1px solid #e5e7eb; 
            border-top-left-radius: 4px; 
        }

        .chat-ai p { margin-bottom: 0.5em; }
        .chat-ai p:last-child { margin-bottom: 0; }
        .chat-ai ul { list-style-type: disc; margin-left: 1.5em; margin-bottom: 0.5em; }
        .chat-ai ol { list-style-type: decimal; margin-left: 1.5em; margin-bottom: 0.5em; }
        .chat-ai strong { font-weight: 600; color: #111827; }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
            width: 90%;
            max-width: 400px;
        }
        .toast-message {
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fecaca;
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease-out;
            pointer-events: auto;
            backdrop-filter: blur(4px);
        }
        .toast-message.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Alert Switch */
        .alert-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .alert-switch input { opacity: 0; width: 0; height: 0; }
        .alert-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 24px;
        }
        .alert-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .alert-slider { background-color: #3b82f6; }
        input:checked + .alert-slider:before { transform: translateX(20px); }

        /* Voice Control Button */
        #voice-control-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 40;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #voice-control-btn:hover {
            transform: scale(1.05);
            background-color: #2563eb;
        }
        #voice-control-btn.listening {
            background-color: #ef4444;
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Voice Control Button -->
    <button id="voice-control-btn" title="ìŒì„±ìœ¼ë¡œ ì œì–´í•˜ê¸°">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
    </button>

    <!-- Alert Settings Modal -->
    <div id="alert-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6 transition-all" style="min-height: 300px;">
            
            <!-- View 1: Alert List -->
            <div id="alert-list-view">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        ğŸ”” ì•Œë¦¼ ëª¨ì•„ë³´ê¸°
                    </h3>
                    <button class="close-modal-btn text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                
                <div id="alert-list-container" class="space-y-3 mb-6 max-h-96 overflow-y-auto no-scrollbar">
                    <!-- Alert items will be injected here -->
                    <p class="text-center text-gray-500 py-4">ë“±ë¡ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>

                <button id="btn-show-add-alert" class="w-full py-3 border-2 border-dashed border-blue-300 text-blue-500 rounded-xl font-semibold hover:bg-blue-50 transition flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    ìƒˆ ì•Œë¦¼ ì¶”ê°€í•˜ê¸°
                </button>
            </div>

            <!-- View 2: Add/Edit Form -->
            <div id="alert-form-view" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2" id="alert-form-title">
                        ğŸ“ ì•Œë¦¼ ì„¤ì • ì¶”ê°€
                    </h3>
                    <button id="btn-cancel-alert" class="text-gray-400 hover:text-gray-600 text-sm">
                        ì·¨ì†Œ
                    </button>
                </div>

                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">ì•Œë¦¼ ì´ë¦„ (ì‘ë¬¼ëª…)</label>
                        <input type="text" id="alert-name" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ì˜ˆ: ìƒì¶”, í† ë§ˆí† ">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">ğŸŒ¡ï¸ ì˜¨ë„ ê²½ê³ </label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="alert-temp-min" class="w-20 border border-gray-300 rounded-lg p-2 text-center focus:ring-blue-500 focus:border-blue-500" placeholder="ìµœì €">
                            <span class="text-gray-500 text-sm">Â°C ë¯¸ë§Œ ~</span>
                            <input type="number" id="alert-temp-max" class="w-20 border border-gray-300 rounded-lg p-2 text-center focus:ring-blue-500 focus:border-blue-500" placeholder="ìµœê³ ">
                            <span class="text-gray-500 text-sm">Â°C ì´ˆê³¼</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">ğŸ’§ ìŠµë„ ê²½ê³ </label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="alert-humid-min" class="w-20 border border-gray-300 rounded-lg p-2 text-center focus:ring-blue-500 focus:border-blue-500" placeholder="ìµœì €">
                            <span class="text-gray-500 text-sm">% ë¯¸ë§Œì¼ ë•Œ</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">ğŸŒ± í† ì–‘ ìˆ˜ë¶„ ê²½ê³ </label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="alert-soil-min" class="w-20 border border-gray-300 rounded-lg p-2 text-center focus:ring-blue-500 focus:border-blue-500" placeholder="ìµœì €">
                            <span class="text-gray-500 text-sm">% ë¯¸ë§Œì¼ ë•Œ</span>
                        </div>
                    </div>
                </div>
                <div class="mt-8">
                    <button id="save-alert-rule" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl transition">
                        ì €ì¥í•˜ê¸°
                    </button>
                </div>
            </div>

        </div>
    </div>


    <!-- Login Screen -->
    <div id="login-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">ğŸŒ¿</h1>
                <h2 class="text-2xl font-bold text-gray-800 mt-2">Smart Farm ë¡œê·¸ì¸</h2>
                <p class="text-gray-500 mt-2">í™˜ì˜í•©ë‹ˆë‹¤!</p>
            </div>
            <form id="login-form">
                <div class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700">ì´ë©”ì¼</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <div class="flex justify-between">
                            <label for="login-password" class="block text-sm font-medium text-gray-700">ë¹„ë°€ë²ˆí˜¸</label>
                            <button type="button" id="go-to-reset" class="text-sm font-medium text-blue-600 hover:text-blue-500">ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?</button>
                        </div>
                        <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <p id="login-error" class="text-red-500 text-sm mt-4 h-5"></p>
                <div class="mt-6">
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">ë¡œê·¸ì¸</button>
                </div>
            </form>
            <p class="mt-6 text-center text-sm text-gray-600">
                ì•„ì§ ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?
                <button id="go-to-signup" class="font-medium text-blue-600 hover:text-blue-500">íšŒì›ê°€ì…</button>
            </p>
        </div>
    </div>

    <!-- Signup Screen -->
    <div id="signup-container" style="display: none;" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">ğŸŒ¿</h1>
                <h2 class="text-2xl font-bold text-gray-800 mt-2">ìƒˆ ê³„ì • ë§Œë“¤ê¸°</h2>
                <p class="text-gray-500 mt-2">ìŠ¤ë§ˆíŠ¸íŒœì„ ì‹œì‘í•´ë³´ì„¸ìš”.</p>
            </div>
            <form id="signup-form">
                <div class="space-y-4">
                     <div>
                        <label for="signup-nickname" class="block text-sm font-medium text-gray-700">ë‹‰ë„¤ì„</label>
                        <input type="text" id="signup-nickname" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-gray-700">ì´ë©”ì¼</label>
                        <input type="email" id="signup-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium text-gray-700">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="signup-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <p class="mt-1 text-xs text-gray-500">8ì ì´ìƒ, ì˜ë¬¸ìì™€ íŠ¹ìˆ˜ë¬¸ì(!@#$%^&*)ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.</p>
                    </div>
                    <div>
                        <label for="signup-password-confirm" class="block text-sm font-medium text-gray-700">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input type="password" id="signup-password-confirm" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <p id="signup-error" class="text-red-500 text-sm mt-4 h-5"></p>
                <div class="mt-6">
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">íšŒì›ê°€ì…</button>
                </div>
            </form>
            <p class="mt-6 text-center text-sm text-gray-600">
                ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?
                <button id="go-to-login-from-signup" class="font-medium text-blue-600 hover:text-blue-500">ë¡œê·¸ì¸</button>
            </p>
        </div>
    </div>

    <!-- Password Reset Screen -->
    <div id="reset-container" style="display: none;" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</h2>
                <p class="text-gray-500 mt-2">ê°€ì… ì‹œ ì‚¬ìš©í•œ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì‹œë©´, ì¬ì„¤ì • ë§í¬ë¥¼ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.</p>
            </div>
            <form id="reset-email-form">
                <div class="space-y-4">
                    <div>
                        <label for="reset-email" class="block text-sm font-medium text-gray-700">ì´ë©”ì¼</label>
                        <input type="email" id="reset-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <p id="reset-error" class="text-red-500 text-sm mt-4 h-5"></p>
                 <p id="reset-success" class="text-green-600 text-sm mt-4 h-5"></p>
                <div class="mt-6">
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">ì¬ì„¤ì • ì´ë©”ì¼ ë°œì†¡</button>
                </div>
            </form>
            <p class="mt-6 text-center text-sm text-gray-600">
                <button id="go-to-login-from-reset" class="font-medium text-blue-600 hover:text-blue-500">ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </p>
        </div>
    </div>
    
    <!-- Edit Profile Screen -->
    <div id="edit-profile-container" style="display: none;" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800">ë‚´ ì •ë³´ ìˆ˜ì •</h2>
                <p class="text-gray-500 mt-2">ë‹‰ë„¤ì„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            <form id="edit-profile-form">
                <div class="space-y-4">
                     <div>
                        <label for="edit-nickname" class="block text-sm font-medium text-gray-700">ë‹‰ë„¤ì„</label>
                        <input type="text" id="edit-nickname" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="edit-password" class="block text-sm font-medium text-gray-700">ìƒˆ ë¹„ë°€ë²ˆí˜¸ (ì„ íƒ)</label>
                        <input type="password" id="edit-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="ë³€ê²½í•  ê²½ìš°ì—ë§Œ ì…ë ¥">
                        <p class="mt-1 text-xs text-gray-500">8ì ì´ìƒ, ì˜ë¬¸ìì™€ íŠ¹ìˆ˜ë¬¸ì(!@#$%^&*)ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.</p>
                    </div>
                    <div>
                        <label for="edit-password-confirm" class="block text-sm font-medium text-gray-700">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input type="password" id="edit-password-confirm" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                <p id="edit-profile-error" class="text-red-500 text-sm mt-4 h-5"></p>
                <p id="edit-profile-success" class="text-green-600 text-sm mt-4 h-5"></p>
                <div class="mt-6 flex gap-3">
                    <button type="button" id="close-edit-profile" class="flex-1 w-full flex justify-center py-3 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">ì·¨ì†Œ</button>
                    <button type="submit" class="flex-1 w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Main App Container -->
    <div id="app-container" style="display: none;" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="mb-8">
             <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                 <!-- Weather Widget (Left) -->
                <div id="weather-widget" class="flex items-center gap-3 bg-white px-4 py-2 rounded-xl shadow-sm border border-gray-200 w-full md:w-auto justify-center md:justify-start">
                    <span id="weather-icon" class="text-3xl">ğŸŒ¥ï¸</span>
                    <div class="text-sm">
                        <p id="weather-location" class="font-bold text-gray-700">ìœ„ì¹˜ í™•ì¸ ì¤‘...</p>
                        <p class="text-gray-500 flex gap-1">
                            <span id="weather-temp">--Â°C</span> / <span id="weather-desc">ë‚ ì”¨ ì •ë³´</span>
                        </p>
                    </div>
                </div>

                <h1 id="dashboard-title" class="text-3xl sm:text-4xl font-bold text-center text-gray-800">ğŸŒ¿ Smart Farm Dashboard</h1>
                
                <div class="text-right w-full md:w-auto text-center md:text-right flex items-center justify-center md:justify-end gap-3">
                    <p id="user-email" class="text-sm text-gray-600 font-medium hidden sm:block"></p>
                    <button id="edit-profile-btn" class="text-sm text-blue-600 hover:underline">ë‚´ ì •ë³´</button>
                    <span class="text-sm text-gray-400">|</span>
                    
                    <!-- Alert Settings Button -->
                    <button id="alert-settings-btn" class="text-gray-500 hover:text-yellow-500 transition" title="ìœ„í—˜ ì•Œë¦¼ ì„¤ì •">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                    </button>

                    <button id="logout-btn" class="text-sm text-red-500 hover:underline">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </header>

        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex -mb-px space-x-6 overflow-x-auto no-scrollbar" aria-label="Tabs">
                <button id="tab-control" class="whitespace-nowrap py-4 px-3 border-b-2 font-medium text-lg text-blue-600 border-blue-600 transition-colors">ì œì–´</button>
                <button id="tab-crops" class="whitespace-nowrap py-4 px-3 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent transition-colors">ì‘ë¬¼ ê´€ë¦¬</button>
                <button id="tab-encyclopedia" class="whitespace-nowrap py-4 px-3 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent transition-colors">ì‹ë¬¼ ë°±ê³¼</button>
                <button id="tab-ai" class="whitespace-nowrap py-4 px-3 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent transition-colors">AI ë†ë¶€</button>
                <button id="tab-stats" class="whitespace-nowrap py-4 px-3 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent transition-colors">í†µê³„</button>
            </nav>
        </div>

        <!-- Control Panel Content -->
        <div id="content-control">
            <!-- Connection Controls -->
            <div class="mb-6 bg-white p-4 rounded-2xl shadow-md border border-gray-200 flex flex-col sm:flex-row items-center justify-center gap-4">
                <button id="connectBtn" class="w-full sm:w-auto flex-1 bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-all flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8.7 15 12l3 3.3"/><path d="M6 12h9"/><path d="M9 8.7 12 12l-3 3.3"/><circle cx="12" cy="12" r="10"/></svg>
                    <span>ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°</span>
                </button>
                <button id="simulateBtn" class="w-full sm:w-auto flex-1 bg-gray-500 hover:bg-gray-600 active:bg-gray-700 text-white font-semibold py-3 px-6 rounded-xl transition-all flex items-center justify-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
                    <span>ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</span>
                </button>
            </div>

            <!-- Profile Pump Status Summary with AI Diagnosis -->
            <div class="bg-white rounded-2xl shadow-md border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <h3 class="text-xl font-semibold text-gray-800">ì‘ë¬¼ íŒí”„ ìƒíƒœ</h3>
                        <span id="active-pump-count" class="flex items-center justify-center w-7 h-7 text-sm font-bold text-white bg-gray-400 rounded-full transition-colors">0</span>
                    </div>
                    <!-- AI Mode Toggle -->
                    <div class="flex items-center gap-2">
                         <span class="text-sm font-medium text-gray-600">AI ì§„ë‹¨</span>
                         <button id="ai-mode-toggle" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 bg-indigo-600" role="switch" aria-checked="true">
                            <span aria-hidden="true" class="translate-x-5 pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                        </button>
                    </div>
                </div>
                <div id="profile-summary-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- JS will populate this -->
                </div>
            </div>
        </div>
        
        <!-- Crops Content -->
        <div id="content-crops" style="display: none;">
            <!-- Settings Profile Management -->
            <div class="mb-6 bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                 <h3 class="text-lg font-semibold text-gray-800 mb-4">ì„¤ì • í”„ë¡œí•„ ê´€ë¦¬</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
                    <div>
                        <label for="profile-select" class="block text-sm font-medium text-gray-700">í”„ë¡œí•„ ì„ íƒ</label>
                        <select id="profile-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div class="flex gap-2">
                         <button id="delete-profile-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition">í”„ë¡œí•„ ì‚­ì œ</button>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t">
                    <label class="block text-sm font-medium text-gray-700">ì•„ì´ì½˜ ì„ íƒ</label>
                    <div id="icon-picker" class="mt-2 flex gap-2 flex-wrap">
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸŒ±</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸ…</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸ“</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸ¥¬</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸ¥•</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸŒ¶ï¸</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸŒ½</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸ†</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸ¥¦</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸ‡</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸ‰</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸŒ»</button>
                    </div>
                </div>
                <div class="mt-4 border-t pt-4">
                      <label for="profile-name-input" class="block text-sm font-medium text-gray-700">í”„ë¡œí•„ ì´ë¦„</label>
                      <div class="mt-1 flex gap-2">
                        <input type="text" id="profile-name-input" placeholder="ìƒˆ ì´ë¦„ ì…ë ¥ ë˜ëŠ” ê¸°ì¡´ ì´ë¦„ ì„ íƒ" class="flex-grow block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2">
                        <button id="save-profile-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition">ì €ì¥ / ì—…ë°ì´íŠ¸</button>
                      </div>
                </div>
            </div>

             <!-- Sensor Grid -->
             <main class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                 <!-- Temperature Card -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200 flex flex-col items-center justify-between">
                    <div class="w-full flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">ì˜¨ë„</h2>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/></svg>
                    </div>
                    <div class="relative w-40 h-40">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="gauge-circle-bg" cx="50" cy="50" r="45"></circle>
                            <circle id="temp-progress" class="gauge-circle-progress stroke-red-500" cx="50" cy="50" r="45"></circle>
                        </svg>
                        <div id="temp-value" class="absolute inset-0 flex items-center justify-center text-3xl font-bold">--â„ƒ</div>
                    </div>
                    <p class="mt-4 text-gray-500 text-sm">í˜„ì¬ ì‹¤ë‚´ ì˜¨ë„</p>
                </div>

                <!-- Humidity Card (with Controls) -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200 flex flex-col items-center justify-between">
                    <div class="w-full flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">ìŠµë„</h2>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/></svg>
                    </div>
                    <div class="relative w-40 h-40">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="gauge-circle-bg" cx="50" cy="50" r="45"></circle>
                            <circle id="humidity-progress" class="gauge-circle-progress stroke-blue-500" cx="50" cy="50" r="45"></circle>
                        </svg>
                        <div id="humidity-value" class="absolute inset-0 flex items-center justify-center text-3xl font-bold">--%</div>
                    </div>
                      <div class="w-full mt-4">
                        <div class="flex items-center justify-between text-sm py-2">
                            <label for="humidity-input" class="text-gray-600">ëª©í‘œ ìŠµë„</label>
                            <div class="flex items-center gap-1">
                                <input id="humidity-input" type="number" min="0" max="100" class="w-16 text-center font-bold text-blue-600 border border-gray-300 rounded-md p-1 focus:ring-blue-500 focus:border-blue-500">
                                <span class="font-semibold text-gray-500">%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Soil Moisture Card -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200 flex flex-col items-center justify-between">
                    <div class="w-full flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">í† ì–‘ ìˆ˜ë¶„</h2>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><path d="M21.2,12.2C21.2,12.2,21.2,12.2,21.2,12.2C19.3,16,16,18.8,12,18.8S4.7,16,2.8,12.2c0,0,0,0,0,0c-1.8-3.9,0.3-7.5,1-8.6 C4.2,2.8,4.9,2.2,5.6,2.1c0,0,0,0,0.1,0C7.2,1.8,9.6,3.3,12,5.7c2.4-2.4,4.8-3.9,6.3-4.1c0,0,0.1,0,0.1,0c0.7,0.1,1.4,0.7,1.8,1.5 C20.9,4.7,23,8.3,21.2,12.2z"/><path d="M12,18.8v3.3"/></svg>
                    </div>
                    <div class="relative w-40 h-40">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="gauge-circle-bg" cx="50" cy="50" r="45"></circle>
                            <circle id="soil-progress" class="gauge-circle-progress stroke-green-500" cx="50" cy="50" r="45"></circle>
                        </svg>
                        <div id="soil-value" class="absolute inset-0 flex items-center justify-center text-3xl font-bold">--%</div>
                    </div>
                      <div class="w-full mt-4">
                        <div class="flex items-center justify-between text-sm py-2">
                            <label for="soil-input" class="text-gray-600">ê¸‰ìˆ˜ ê¸°ì¤€</label>
                            <div class="flex items-center gap-1">
                                <input id="soil-input" type="number" min="0" max="100" class="w-16 text-center font-bold text-green-600 border border-gray-300 rounded-md p-1 focus:ring-green-500 focus:border-green-500">
                                <span class="font-semibold text-gray-500">%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Light Intensity Card -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200 flex flex-col items-center justify-between">
                    <div class="w-full flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">ì¡°ë„</h2>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m4.93 19.07 1.41-1.41"/><path d="m17.66 6.34 1.41-1.41"/></svg>
                    </div>
                    <div class="relative w-40 h-40">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="gauge-circle-bg" cx="50" cy="50" r="45"></circle>
                            <circle id="light-progress" class="gauge-circle-progress stroke-yellow-500" cx="50" cy="50" r="45"></circle>
                        </svg>
                        <div id="light-value" class="absolute inset-0 flex items-center justify-center text-3xl font-bold">--lx</div>
                    </div>
                    <p class="mt-4 text-gray-500 text-sm">í˜„ì¬ ì¡°ë„ëŸ‰</p>
                </div>
             </main>
             <!-- Chart Grid -->
             <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                 <!-- Temperature Chart -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ì˜¨ë„ ë³€í™” (Â°C)</h3>
                    <div class="h-64"><canvas id="tempChart"></canvas></div>
                </div>
                <!-- Humidity Chart -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ìŠµë„ ë³€í™” (%)</h3>
                    <div class="h-64"><canvas id="humidityChart"></canvas></div>
                </div>
                <!-- Soil Moisture Chart -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">í† ì–‘ ìˆ˜ë¶„ ë³€í™” (%)</h3>
                    <div class="h-64"><canvas id="soilChart"></canvas></div>
                </div>
                <!-- Light Intensity Chart -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ì¡°ë„ ë³€í™” (lx)</h3>
                    <div class="h-64"><canvas id="lightChart"></canvas></div>
                </div>
             </div>
        </div>

        <!-- NEW: Plant Encyclopedia Content -->
        <div id="content-encyclopedia" style="display: none;">
             <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200 mb-6">
                <div class="flex flex-col md:flex-row gap-4 justify-between items-center">
                     <h3 class="text-xl font-bold text-gray-800">ì‹ë¬¼ ë°±ê³¼ì‚¬ì „</h3>
                     <div class="flex w-full md:w-auto gap-2">
                        <input type="text" id="plant-search-input" placeholder="ì‹ë¬¼ ì´ë¦„ ê²€ìƒ‰..." class="flex-grow md:w-64 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="plant-search-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition font-medium">ê²€ìƒ‰</button>
                     </div>
                </div>
                <div class="flex gap-2 mt-4 overflow-x-auto no-scrollbar pb-2" id="category-filters">
                    <button class="plant-category-btn active px-4 py-1.5 rounded-full bg-gray-100 text-gray-600 text-sm font-medium whitespace-nowrap hover:bg-gray-200 transition" data-category="all">ì „ì²´</button>
                    <button class="plant-category-btn px-4 py-1.5 rounded-full bg-gray-100 text-gray-600 text-sm font-medium whitespace-nowrap hover:bg-gray-200 transition" data-category="leaf">ìì±„ì†Œ</button>
                    <button class="plant-category-btn px-4 py-1.5 rounded-full bg-gray-100 text-gray-600 text-sm font-medium whitespace-nowrap hover:bg-gray-200 transition" data-category="fruit">ì—´ë§¤ì±„ì†Œ</button>
                    <button class="plant-category-btn px-4 py-1.5 rounded-full bg-gray-100 text-gray-600 text-sm font-medium whitespace-nowrap hover:bg-gray-200 transition" data-category="root">ë¿Œë¦¬ì±„ì†Œ</button>
                    <button class="plant-category-btn px-4 py-1.5 rounded-full bg-gray-100 text-gray-600 text-sm font-medium whitespace-nowrap hover:bg-gray-200 transition" data-category="herb">í—ˆë¸Œ/ê¸°íƒ€</button>
                </div>
             </div>

             <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="plant-list">
                <!-- JS will populate plant cards here -->
            </div>
            <div id="no-plant-results" class="text-center text-gray-500 mt-10 hidden">
                <p class="text-lg">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ğŸ¤”</p>
            </div>
        </div>

        <!-- AI Farmer Content -->
        <div id="content-ai" style="display: none;">
            <div class="bg-white rounded-2xl shadow-md border border-gray-200 p-6 h-[600px] flex flex-col">
                <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-100">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <span>ğŸ¤–</span> AI ë†ë¶€ ìƒë‹´ì†Œ
                    </h3>
                </div>
                
                <div id="chat-history" class="flex-1 overflow-y-auto mb-4 flex flex-col gap-4 p-2 bg-gray-50 rounded-xl border border-gray-100">
                    <div class="chat-message ai">
                        <div class="chat-avatar">ğŸ¤–</div>
                        <div class="chat-bubble">
                            <p>ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ë‹¹ì‹ ì˜ ìŠ¤ë§ˆíŠ¸íŒœ AI ë¹„ì„œì…ë‹ˆë‹¤. ğŸŒ±</p>
                            <p>í˜„ì¬ ì„¼ì„œ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê±°ë‚˜, ì‹ë¬¼ í‚¤ìš°ëŠ” íŒì„ ì•Œë ¤ë“œë¦´ ìˆ˜ ìˆì–´ìš”. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</p>
                        </div>
                    </div>
                </div>

                <!-- Suggestion Chips -->
                <div class="flex gap-2 mb-3 overflow-x-auto no-scrollbar" id="chat-suggestions">
                    <button class="whitespace-nowrap px-3 py-1.5 rounded-full bg-gray-100 text-sm text-gray-600 hover:bg-gray-200 transition border border-gray-200">ì§€ê¸ˆ ë‚´ ì‘ë¬¼ ìƒíƒœ ì–´ë•Œ? ğŸŒ±</button>
                    <button class="whitespace-nowrap px-3 py-1.5 rounded-full bg-gray-100 text-sm text-gray-600 hover:bg-gray-200 transition border border-gray-200">ë¬¼ì€ ì–¼ë§ˆë‚˜ ìì£¼ ì¤˜ì•¼ í•´? ğŸ’§</button>
                    <button class="whitespace-nowrap px-3 py-1.5 rounded-full bg-gray-100 text-sm text-gray-600 hover:bg-gray-200 transition border border-gray-200">ìƒì¶” ì˜ í‚¤ìš°ëŠ” ê¿€íŒ ì•Œë ¤ì¤˜ ğŸ¥¬</button>
                    <button class="whitespace-nowrap px-3 py-1.5 rounded-full bg-gray-100 text-sm text-gray-600 hover:bg-gray-200 transition border border-gray-200">ìŠµë„ê°€ ì ë‹¹í•œê°€ìš”? ğŸŒ¡ï¸</button>
                </div>

                <!-- NEW: Image Preview Container -->
                <div id="image-preview-container" class="hidden mb-2 p-2 bg-gray-50 rounded-lg border border-gray-200 flex items-center gap-2">
                    <img id="image-preview" class="h-16 w-16 object-cover rounded" src="">
                    <div class="flex-1 text-sm text-gray-600 truncate" id="image-name"></div>
                    <button id="remove-image-btn" class="text-gray-400 hover:text-red-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>

                <div class="flex gap-2 items-end">
                    <!-- Hidden File Input -->
                    <input type="file" id="image-upload" accept="image/*" class="hidden">
                    <!-- Camera/Upload Button -->
                    <button id="upload-btn" class="p-3 text-gray-500 hover:text-blue-500 bg-white border border-gray-300 rounded-xl transition" title="ì‚¬ì§„ ì—…ë¡œë“œ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                    </button>
                    
                    <textarea id="chat-input" rows="1" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ: ì´ ì‹ë¬¼ ë­ì•¼?)" class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                    <button id="send-chat-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 rounded-xl transition flex items-center justify-center h-[50px]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Statistics/History Content -->
        <div id="content-stats" style="display: none;">
            <div class="bg-white rounded-2xl shadow-md border border-gray-200 p-6">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">ë‚ ì§œë³„ ë°ì´í„° ì¡°íšŒ</h3>
                    <div class="flex items-center gap-2">
                        <label for="history-date-picker" class="text-sm font-medium text-gray-700">ë‚ ì§œ ì„ íƒ:</label>
                        <input type="date" id="history-date-picker" class="border-gray-300 rounded-md shadow-sm">
                        <!-- CSV Download Button -->
                        <button id="download-csv-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition text-sm font-medium flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                </div>
                <div id="history-chart-container" class="h-96 relative">
                    <canvas id="historyChart"></canvas>
                    <div id="history-no-data" class="absolute inset-0 flex items-center justify-center text-gray-500" style="display: none;">
                        <p>í•´ë‹¹ ë‚ ì§œì— ê¸°ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            sendPasswordResetEmail,
            updateProfile,
            updatePassword
        } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            getDoc, 
            deleteDoc, 
            onSnapshot, 
            addDoc, 
            serverTimestamp, 
            query, 
            where, 
            orderBy, 
            getDocs, 
            Timestamp
        } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        // User's Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC4GOpTEhpFMLySLWIKt545mCgRn1M2crU",
            authDomain: "smart-farm-866d9.firebaseapp.com",
            projectId: "smart-farm-866d9",
            storageBucket: "smart-farm-866d9.appspot.com",
            messagingSenderId: "1080160151921",
            appId: "1:1080160151921:web:3180811a31782d6835aed0",
            measurementId: "G-2M1X8VZJVE"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Expanded Plant Data ---
        const plantData = [
            { name: 'ìƒì¶”', category: 'leaf', icon: 'ğŸ¥¬', temp: '15~20Â°C', humidity: '50~70%', soil: '60~80%', light: 'ì¤‘ê°„', desc: 'ì„œëŠ˜í•œ ê¸°í›„ë¥¼ ì¢‹ì•„í•˜ë©°, ë¬¼ì„ ìì£¼ ì£¼ì–´ì•¼ ì—°í•˜ê³  ë§›ì´ ì¢‹ìŠµë‹ˆë‹¤.' },
            { name: 'ì‹œê¸ˆì¹˜', category: 'leaf', icon: 'ğŸ¥¬', temp: '15~20Â°C', humidity: '60~70%', soil: '60~70%', light: 'ì¤‘ê°„', desc: 'ì² ë¶„ì´ í’ë¶€í•˜ë©° ì„œëŠ˜í•œ ê³³ì—ì„œ ì˜ ìëë‹ˆë‹¤. ì‚°ì„± í† ì–‘ì„ ì‹«ì–´í•©ë‹ˆë‹¤.' },
            { name: 'ì¼€ì¼', category: 'leaf', icon: 'ğŸ¥¬', temp: '15~20Â°C', humidity: '60~70%', soil: '60~70%', light: 'ë†’ìŒ', desc: 'ë² íƒ€ì¹´ë¡œí‹´ì´ í’ë¶€í•˜ë©° ë³‘ì¶©í•´ì— ê°•í•œ í¸ì…ë‹ˆë‹¤.' },
            { name: 'ë°°ì¶”', category: 'leaf', icon: 'ğŸ¥¬', temp: '18~22Â°C', humidity: '60~80%', soil: '60~70%', light: 'ë†’ìŒ', desc: 'ì„œëŠ˜í•œ ê¸°í›„ë¥¼ ì¢‹ì•„í•˜ê³  ë¬¼ì„ ë§ì´ í•„ìš”ë¡œ í•©ë‹ˆë‹¤.' },
            { name: 'ì–‘ë°°ì¶”', category: 'leaf', icon: 'ğŸ¥¬', temp: '15~20Â°C', humidity: '60~70%', soil: '60~70%', light: 'ì¤‘ê°„', desc: 'ë¹„ì˜¥í•œ í† ì–‘ì„ ì¢‹ì•„í•˜ë©° ì„œëŠ˜í•œ ê³³ì—ì„œ ê²°êµ¬ê°€ ì˜ ë©ë‹ˆë‹¤.' },
            { name: 'í† ë§ˆí† ', category: 'fruit', icon: 'ğŸ…', temp: '20~25Â°C', humidity: '60~80%', soil: '60~70%', light: 'ë†’ìŒ', desc: 'í–‡ë¹›ì„ ë§ì´ í•„ìš”ë¡œ í•˜ë©°, ë°°ìˆ˜ê°€ ì˜ ë˜ëŠ” í† ì–‘ì„ ì¢‹ì•„í•©ë‹ˆë‹¤.' },
            { name: 'ë°©ìš¸í† ë§ˆí† ', category: 'fruit', icon: 'ğŸ…', temp: '20~25Â°C', humidity: '60~80%', soil: '60~70%', light: 'ë†’ìŒ', desc: 'ì¼ë°˜ í† ë§ˆí† ë³´ë‹¤ í‚¤ìš°ê¸° ì‰½ê³  ì—´ë§¤ê°€ ë§ì´ ë‹¬ë¦½ë‹ˆë‹¤.' },
            { name: 'ë”¸ê¸°', category: 'fruit', icon: 'ğŸ“', temp: '17~23Â°C', humidity: '50~60%', soil: '50~70%', light: 'ë†’ìŒ', desc: 'í†µí’ì´ ì˜ ë˜ê³  í–‡ë¹›ì´ ì˜ ë“œëŠ” ê³³ì—ì„œ ì˜ ìëë‹ˆë‹¤.' },
            { name: 'ê³ ì¶”', category: 'fruit', icon: 'ğŸŒ¶ï¸', temp: '25~30Â°C', humidity: '60~70%', soil: '60~70%', light: 'ë†’ìŒ', desc: 'ê³ ì˜¨ì„± ì‘ë¬¼ë¡œ ë”°ëœ»í•œ í™˜ê²½ì„ ì¢‹ì•„í•©ë‹ˆë‹¤.' },
            { name: 'ê°€ì§€', category: 'fruit', icon: 'ğŸ†', temp: '22~30Â°C', humidity: '60~80%', soil: '60~70%', light: 'ë†’ìŒ', desc: 'ë¬¼ì„ ë§¤ìš° ì¢‹ì•„í•˜ë©° ê³ ì˜¨ ë‹¤ìŠµí•œ í™˜ê²½ì—ì„œ ì˜ ìëë‹ˆë‹¤.' },
            { name: 'ì˜¤ì´', category: 'fruit', icon: 'ğŸ¥’', temp: '20~28Â°C', humidity: '70~90%', soil: '70~80%', light: 'ë†’ìŒ', desc: 'ë¿Œë¦¬ê°€ ì–•ì•„ ê±´ì¡°ì— ì•½í•˜ë¯€ë¡œ ë¬¼ì„ ìì£¼ ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.' },
            { name: 'í˜¸ë°•', category: 'fruit', icon: 'ğŸƒ', temp: '20~25Â°C', humidity: '60~70%', soil: '60~70%', light: 'ë†’ìŒ', desc: 'ë©êµ´ì„± ì‹ë¬¼ë¡œ ë„“ì€ ê³µê°„ì´ í•„ìš”í•©ë‹ˆë‹¤.' },
            { name: 'ìˆ˜ë°•', category: 'fruit', icon: 'ğŸ‰', temp: '25~30Â°C', humidity: '50~60%', soil: '50~60%', light: 'ë§¤ìš° ë†’ìŒ', desc: 'ê³ ì˜¨ ê±´ì¡°í•˜ê³  í–‡ë¹›ì´ ê°•í•œ ê³³ì„ ì¢‹ì•„í•©ë‹ˆë‹¤.' },
            { name: 'ì°¸ì™¸', category: 'fruit', icon: 'ğŸˆ', temp: '25~30Â°C', humidity: '50~60%', soil: '50~60%', light: 'ë†’ìŒ', desc: 'ë°°ìˆ˜ê°€ ì˜ ë˜ëŠ” ì‚¬ì–‘í† ì—ì„œ ì˜ ìëë‹ˆë‹¤.' },
            { name: 'íŒŒí”„ë¦¬ì¹´', category: 'fruit', icon: 'ğŸ«‘', temp: '20~25Â°C', humidity: '60~70%', soil: '60~70%', light: 'ë†’ìŒ', desc: 'ì˜¨ë„ì— ë¯¼ê°í•˜ë¯€ë¡œ ì ì • ì˜¨ë„ë¥¼ ìœ ì§€í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.' },
            { name: 'ë‹¹ê·¼', category: 'root', icon: 'ğŸ¥•', temp: '15~21Â°C', humidity: '50~70%', soil: '50~60%', light: 'ì¤‘ê°„', desc: 'ë¿Œë¦¬ ì±„ì†Œë¡œ ê¹Šê³  ë¶€ë“œëŸ¬ìš´ í™ì´ í•„ìš”í•©ë‹ˆë‹¤.' },
            { name: 'ë¬´', category: 'root', icon: 'ğŸ¥¬', temp: '15~20Â°C', humidity: '60~70%', soil: '60~70%', light: 'ì¤‘ê°„', desc: 'ì„œëŠ˜í•œ ê¸°í›„ì—ì„œ ì˜ ìë¼ë©° í™ì´ ë¶€ë“œëŸ¬ì›Œì•¼ í•©ë‹ˆë‹¤.' },
            { name: 'ê°ì', category: 'root', icon: 'ğŸ¥”', temp: '15~20Â°C', humidity: '60~70%', soil: '50~60%', light: 'ë†’ìŒ', desc: 'ì„œëŠ˜í•œ ê¸°í›„ë¥¼ ì¢‹ì•„í•˜ë©° ë°°ìˆ˜ê°€ ì˜ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.' },
            { name: 'ê³ êµ¬ë§ˆ', category: 'root', icon: 'ğŸ ', temp: '20~30Â°C', humidity: '60~70%', soil: '50~60%', light: 'ë†’ìŒ', desc: 'ê³ ì˜¨ì„± ì‘ë¬¼ë¡œ ì²™ë°•í•œ ë•…ì—ì„œë„ ì˜ ìëë‹ˆë‹¤.' },
            { name: 'ì–‘íŒŒ', category: 'root', icon: 'ğŸ§…', temp: '15~20Â°C', humidity: '60~70%', soil: '50~60%', light: 'ë†’ìŒ', desc: 'í–‡ë¹›ì„ ì¢‹ì•„í•˜ë©° ë°°ìˆ˜ê°€ ì˜ ë˜ëŠ” ê³³ì´ ì¢‹ìŠµë‹ˆë‹¤.' },
            { name: 'ë§ˆëŠ˜', category: 'root', icon: 'ğŸ§„', temp: '15~20Â°C', humidity: '60~70%', soil: '50~60%', light: 'ë†’ìŒ', desc: 'ì„œëŠ˜í•œ ê¸°í›„ì—ì„œ ì˜ ìë¼ë©° ì›”ë™ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.' },
            { name: 'ë°”ì§ˆ', category: 'herb', icon: 'ğŸŒ¿', temp: '20~25Â°C', humidity: '40~60%', soil: '40~60%', light: 'ë†’ìŒ', desc: 'ë”°ëœ»í•˜ê³  ê±´ì¡°í•œ í™˜ê²½ì„ ì¢‹ì•„í•˜ë©° ê³¼ìŠµì— ì£¼ì˜í•´ì•¼ í•©ë‹ˆë‹¤.' },
            { name: 'ë¯¼íŠ¸', category: 'herb', icon: 'ğŸŒ¿', temp: '15~20Â°C', humidity: '50~70%', soil: '50~70%', light: 'ë°˜ìŒì§€', desc: 'ë²ˆì‹ë ¥ì´ ë§¤ìš° ê°•í•˜ë©° ë°˜ê·¸ëŠ˜ì—ì„œë„ ì˜ ìëë‹ˆë‹¤.' },
            { name: 'ë¡œì¦ˆë§ˆë¦¬', category: 'herb', icon: 'ğŸŒ¿', temp: '15~25Â°C', humidity: '40~50%', soil: '30~50%', light: 'ë†’ìŒ', desc: 'ê±´ì¡°ì— ê°•í•˜ê³  ê³¼ìŠµì„ ì‹«ì–´í•˜ë¯€ë¡œ ë¬¼ì„ ì ê²Œ ì¤ë‹ˆë‹¤.' },
            { name: 'ë¼ë²¤ë”', category: 'herb', icon: 'ğŸª»', temp: '15~25Â°C', humidity: '40~50%', soil: '30~50%', light: 'ë†’ìŒ', desc: 'í–‡ë¹›ê³¼ í†µí’ì´ ì¤‘ìš”í•˜ë©° ê±´ì¡°í•˜ê²Œ í‚¤ì›Œì•¼ í•©ë‹ˆë‹¤.' },
            { name: 'ì˜¥ìˆ˜ìˆ˜', category: 'herb', icon: 'ğŸŒ½', temp: '25~32Â°C', humidity: '50~70%', soil: '50~70%', light: 'ë†’ìŒ', desc: 'ë¹„ë£Œë¥¼ ë§ì´ í•„ìš”ë¡œ í•˜ë©° í–‡ë¹›ì´ ê°•í•´ì•¼ í•©ë‹ˆë‹¤.' },
            { name: 'ë¸Œë¡œì½œë¦¬', category: 'herb', icon: 'ğŸ¥¦', temp: '16~20Â°C', humidity: '60~70%', soil: '60~80%', light: 'ì¤‘ê°„', desc: 'ì„œëŠ˜í•œ ê¸°í›„ë¥¼ ì¢‹ì•„í•©ë‹ˆë‹¤.' },
            { name: 'ì½©', category: 'herb', icon: 'ğŸ«˜', temp: '20~25Â°C', humidity: '60~70%', soil: '60~70%', light: 'ë†’ìŒ', desc: 'ë”°ëœ»í•œ ê³³ì„ ì¢‹ì•„í•˜ë©° ì²™ë°•í•œ ë•…ì—ì„œë„ ì˜ ìëë‹ˆë‹¤.' },
             { name: 'ë²¼', category: 'herb', icon: 'ğŸŒ¾', temp: '25~30Â°C', humidity: '70~90%', soil: '80~90%', light: 'ë§¤ìš° ë†’ìŒ', desc: 'ë¬¼ê³¼ í–‡ë¹›ì„ ë§¤ìš° ë§ì´ í•„ìš”ë¡œ í•©ë‹ˆë‹¤.' }
        ];

        // --- DOM Elements ---
        const loginContainer = document.getElementById('login-container');
        const signupContainer = document.getElementById('signup-container');
        const resetContainer = document.getElementById('reset-container');
        const editProfileContainer = document.getElementById('edit-profile-container');
        const appContainer = document.getElementById('app-container');
        
        const loginForm = document.getElementById('login-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginErrorEl = document.getElementById('login-error');
        
        const signupForm = document.getElementById('signup-form');
        const signupNicknameInput = document.getElementById('signup-nickname');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupPasswordConfirmInput = document.getElementById('signup-password-confirm');
        const signupErrorEl = document.getElementById('signup-error');

        const resetEmailForm = document.getElementById('reset-email-form');
        const resetEmailInput = document.getElementById('reset-email');
        const resetErrorEl = document.getElementById('reset-error');
        const resetSuccessEl = document.getElementById('reset-success');
        
        const editProfileForm = document.getElementById('edit-profile-form');
        const editNicknameInput = document.getElementById('edit-nickname');
        const editPasswordInput = document.getElementById('edit-password');
        const editPasswordConfirmInput = document.getElementById('edit-password-confirm');
        const editProfileErrorEl = document.getElementById('edit-profile-error');
        const editProfileSuccessEl = document.getElementById('edit-profile-success');
        const closeEditProfileBtn = document.getElementById('close-edit-profile');

        const goToSignupBtn = document.getElementById('go-to-signup');
        const goToLoginFromSignupBtn = document.getElementById('go-to-login-from-signup');
        const goToResetBtn = document.getElementById('go-to-reset');
        const goToLoginFromResetBtn = document.getElementById('go-to-login-from-reset');
        
        const dashboardTitleEl = document.getElementById('dashboard-title');
        const userEmailEl = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const tabControl = document.getElementById('tab-control');
        const tabCrops = document.getElementById('tab-crops');
        const tabEncyclopedia = document.getElementById('tab-encyclopedia');
        const tabAi = document.getElementById('tab-ai');
        const tabStats = document.getElementById('tab-stats');
        
        const contentControl = document.getElementById('content-control');
        const contentCrops = document.getElementById('content-crops');
        const contentEncyclopedia = document.getElementById('content-encyclopedia');
        const contentAi = document.getElementById('content-ai');
        const contentStats = document.getElementById('content-stats');

        const tempValueEl = document.getElementById('temp-value');
        const tempProgressEl = document.getElementById('temp-progress');
        const humidityValueEl = document.getElementById('humidity-value');
        const humidityProgressEl = document.getElementById('humidity-progress');
        const soilValueEl = document.getElementById('soil-value');
        const soilProgressEl = document.getElementById('soil-progress');
        const lightValueEl = document.getElementById('light-value');
        const lightProgressEl = document.getElementById('light-progress');
        const humidityInput = document.getElementById('humidity-input');
        const soilInput = document.getElementById('soil-input');
        const connectBtn = document.getElementById('connectBtn');
        const simulateBtn = document.getElementById('simulateBtn');
        const profileSelect = document.getElementById('profile-select');
        const profileNameInput = document.getElementById('profile-name-input');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const deleteProfileBtn = document.getElementById('delete-profile-btn');
        const profileSummaryList = document.getElementById('profile-summary-list');
        const iconPicker = document.getElementById('icon-picker');
        const activePumpCountEl = document.getElementById('active-pump-count');
        const historyDatePicker = document.getElementById('history-date-picker');
        const historyChartContainer = document.getElementById('history-chart-container');
        const historyNoDataEl = document.getElementById('history-no-data');
        const plantListContainer = document.getElementById('plant-list');
        const plantSearchInput = document.getElementById('plant-search-input');
        const plantSearchBtn = document.getElementById('plant-search-btn');
        const noPlantResultsEl = document.getElementById('no-plant-results');
        const categoryButtons = document.querySelectorAll('.plant-category-btn');
        const aiModeToggle = document.getElementById('ai-mode-toggle');
        const downloadCsvBtn = document.getElementById('download-csv-btn');

        // Alert Settings Elements
        const alertSettingsBtn = document.getElementById('alert-settings-btn');
        const alertSettingsModal = document.getElementById('alert-settings-modal');
        const closeModalBtns = document.querySelectorAll('.close-modal-btn');
        const btnShowAddAlert = document.getElementById('btn-show-add-alert');
        const btnCancelAlert = document.getElementById('btn-cancel-alert');
        const alertListView = document.getElementById('alert-list-view');
        const alertFormView = document.getElementById('alert-form-view');
        const alertListContainer = document.getElementById('alert-list-container');
        
        const saveAlertRuleBtn = document.getElementById('save-alert-rule');
        const alertNameInput = document.getElementById('alert-name');
        const alertTempMinInput = document.getElementById('alert-temp-min');
        const alertTempMaxInput = document.getElementById('alert-temp-max');
        const alertHumidMinInput = document.getElementById('alert-humid-min');
        const alertSoilMinInput = document.getElementById('alert-soil-min');
        const toastContainer = document.getElementById('toast-container');

        // Voice Control Element
        const voiceControlBtn = document.getElementById('voice-control-btn');

        // AI Chat Elements
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const imageUpload = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const imageName = document.getElementById('image-name');
        const removeImageBtn = document.getElementById('remove-image-btn');
        
        // --- State Variables ---
        let currentUserId = null;
        let unsubscribeProfiles = null; 
        let device = null, characteristic = null, isConnected = false, simulationInterval = null, dataLogInterval = null;
        let tempChart, humidityChart, soilChart, lightChart, historyChart;
        let settingsProfiles = {};
        let selectedIcon = 'ğŸŒ±';
        const circumference = 2 * Math.PI * 45;
        let currentTemp = 0.0, currentHumidity = 0, currentSoil = 0, currentLight = 0;
        let targetHumidity = 65, targetSoil = 70;
        let currentPlantFilter = 'all';
        let currentPlantSearch = '';
        let isAIModeEnabled = true;
        let currentImageBase64 = null;
        let currentHistoryData = [];

        // Alert Rules State (Array of objects)
        let alertRules = [];
        let lastAlertTime = 0; // For cooldown
        const ALERT_COOLDOWN = 60000; // 1 minute cooldown
        
        // Hardcoded Gemini API Key
        const geminiApiKey = "AIzaSyBgD92z-7ekoc5Mc4FTzGAkC7B-c7DAiXQ";

        // --- Firebase Auth Logic ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                loginContainer.style.display = 'none';
                signupContainer.style.display = 'none';
                resetContainer.style.display = 'none';
                editProfileContainer.style.display = 'none';
                appContainer.style.display = 'block';
                userEmailEl.textContent = user.email;
                dashboardTitleEl.textContent = `ğŸŒ¿ ${(user.displayName || 'ë‚˜')}ì˜ ìŠ¤ë§ˆíŠ¸íŒœ`;
                listenToProfiles(currentUserId);
                
                // Load Alert Rules from LocalStorage
                const savedRules = localStorage.getItem(`alertRules_${currentUserId}`);
                if (savedRules) {
                    try {
                        alertRules = JSON.parse(savedRules);
                        // Migrate old single object structure if necessary
                        if (!Array.isArray(alertRules)) {
                             alertRules = [{
                                 id: Date.now(),
                                 name: 'ê¸°ë³¸ ì•Œë¦¼',
                                 enabled: true,
                                 ...alertRules
                             }];
                             localStorage.setItem(`alertRules_${currentUserId}`, JSON.stringify(alertRules));
                        }
                    } catch (e) {
                        alertRules = [];
                    }
                } else {
                    alertRules = [];
                }
                renderAlertList();

                // Auto-fetch today's data on login
                if (historyDatePicker.value) {
                    fetchHistoryData(historyDatePicker.value);
                }
                // Fetch weather data after login
                fetchWeather();
            } else {
                currentUserId = null;
                loginContainer.style.display = 'flex';
                signupContainer.style.display = 'none';
                resetContainer.style.display = 'none';
                editProfileContainer.style.display = 'none';
                appContainer.style.display = 'none';
                if (unsubscribeProfiles) unsubscribeProfiles();
                settingsProfiles = {};
                updateProfileSelect();
                updateProfileSummary();
            }
        });

        // ... (Login/Signup/Reset Event Listeners omitted for brevity, same as previous) ...
        // Re-adding them to be safe and complete
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            loginErrorEl.textContent = '';
            signInWithEmailAndPassword(auth, loginEmailInput.value, loginPasswordInput.value)
                .catch(error => {
                    switch(error.code) {
                        case 'auth/user-not-found': loginErrorEl.textContent = 'ê°€ì…ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.'; break;
                        case 'auth/wrong-password': loginErrorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'; break;
                        default: loginErrorEl.textContent = 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                    }
                });
        });

        signupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            signupErrorEl.textContent = '';
            const nickname = signupNicknameInput.value.trim();
            const email = signupEmailInput.value;
            const password = signupPasswordInput.value;
            const confirmPassword = signupPasswordConfirmInput.value;

            if (!nickname) { signupErrorEl.textContent = 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'; return; }
            const passwordRegex = /^(?=.*[A-Za-z])(?=.*[!@#$%^&*]).{8,}$/;
            if (!passwordRegex.test(password)) {
                signupErrorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒ, ì˜ë¬¸ìì™€ íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.';
                return;
            }
            if (password !== confirmPassword) { signupErrorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'; return; }
            
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    return updateProfile(userCredential.user, { displayName: nickname });
                })
                .catch(error => {
                    switch(error.code) {
                        case 'auth/email-already-in-use': signupErrorEl.textContent = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.'; break;
                        case 'auth/invalid-email': signupErrorEl.textContent = 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.'; break;
                        default: signupErrorEl.textContent = 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                    }
                });
        });

        resetEmailForm.addEventListener('submit', (e) => {
            e.preventDefault();
            resetErrorEl.textContent = '';
            resetSuccessEl.textContent = '';
            const email = resetEmailInput.value;
            sendPasswordResetEmail(auth, email)
                .then(() => {
                    resetSuccessEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤!';
                })
                .catch(error => {
                    resetErrorEl.textContent = 'ì´ë©”ì¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                });
        });
        
        editProfileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            editProfileErrorEl.textContent = '';
            editProfileSuccessEl.textContent = '';
            const newNickname = editNicknameInput.value.trim();
            const newPassword = editPasswordInput.value;
            const newPasswordConfirm = editPasswordConfirmInput.value;
            const user = auth.currentUser;

            if (!user) return;

            try {
                if (newNickname && newNickname !== user.displayName) {
                    await updateProfile(user, { displayName: newNickname });
                }

                if (newPassword) {
                    const passwordRegex = /^(?=.*[A-Za-z])(?=.*[!@#$%^&*]).{8,}$/;
                    if (!passwordRegex.test(newPassword)) {
                        editProfileErrorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒ, ì˜ë¬¸ìì™€ íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.';
                        return;
                    }
                    if (newPassword !== newPasswordConfirm) {
                        editProfileErrorEl.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                        return;
                    }
                    await updatePassword(user, newPassword);
                }
                
                editProfileSuccessEl.textContent = "ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.";
                setTimeout(() => {
                    editProfileContainer.style.display = 'none';
                    appContainer.style.display = 'block';
                }, 1500);

            } catch (error) {
                console.error("Profile update error:", error);
                editProfileErrorEl.textContent = "ì •ë³´ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í›„ ì‹œë„í•´ì£¼ì„¸ìš”.";
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));
        
        // --- Page Navigation ---
        goToSignupBtn.addEventListener('click', () => { loginContainer.style.display = 'none'; signupContainer.style.display = 'flex'; });
        goToLoginFromSignupBtn.addEventListener('click', () => { signupContainer.style.display = 'none'; loginContainer.style.display = 'flex'; });
        goToResetBtn.addEventListener('click', () => { loginContainer.style.display = 'none'; resetContainer.style.display = 'flex'; });
        goToLoginFromResetBtn.addEventListener('click', () => { resetContainer.style.display = 'none'; loginContainer.style.display = 'flex'; });
        editProfileBtn.addEventListener('click', () => {
            const user = auth.currentUser;
            if (user) {
                editNicknameInput.value = user.displayName || '';
                editPasswordInput.value = '';
                editPasswordConfirmInput.value = '';
                editProfileErrorEl.textContent = '';
                editProfileSuccessEl.textContent = '';
                appContainer.style.display = 'none';
                editProfileContainer.style.display = 'flex';
            }
        });
        closeEditProfileBtn.addEventListener('click', () => {
            editProfileContainer.style.display = 'none';
            appContainer.style.display = 'block';
        });

        // --- Alert Settings Logic (NEW) ---
        alertSettingsBtn.addEventListener('click', () => {
            alertSettingsModal.classList.remove('hidden');
            renderAlertList();
            // Ensure list view is shown first
            alertListView.classList.remove('hidden');
            alertFormView.classList.add('hidden');
        });
        
        closeModalBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                alertSettingsModal.classList.add('hidden');
            });
        });

        btnShowAddAlert.addEventListener('click', () => {
            alertListView.classList.add('hidden');
            alertFormView.classList.remove('hidden');
            // Reset form
            alertNameInput.value = '';
            alertTempMinInput.value = '';
            alertTempMaxInput.value = '';
            alertHumidMinInput.value = '';
            alertSoilMinInput.value = '';
        });

        btnCancelAlert.addEventListener('click', () => {
            alertFormView.classList.add('hidden');
            alertListView.classList.remove('hidden');
        });

        saveAlertRuleBtn.addEventListener('click', () => {
            const name = alertNameInput.value.trim();
            if(!name) { showToast("ì•Œë¦¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error"); return; }

            const newRule = {
                id: Date.now(),
                name: name,
                enabled: true,
                tempMin: parseFloat(alertTempMinInput.value) || -999,
                tempMax: parseFloat(alertTempMaxInput.value) || 999,
                humidMin: parseInt(alertHumidMinInput.value) || 0,
                soilMin: parseInt(alertSoilMinInput.value) || 0
            };
            
            alertRules.push(newRule);
            saveRulesToStorage();
            
            alertFormView.classList.add('hidden');
            alertListView.classList.remove('hidden');
            renderAlertList();
            showToast("ìƒˆ ì•Œë¦¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
        });

        function saveRulesToStorage() {
            if (currentUserId) {
                localStorage.setItem(`alertRules_${currentUserId}`, JSON.stringify(alertRules));
            }
        }

        function renderAlertList() {
            alertListContainer.innerHTML = '';
            if (alertRules.length === 0) {
                alertListContainer.innerHTML = '<p class="text-center text-gray-500 py-4">ë“±ë¡ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>';
                return;
            }

            alertRules.forEach(rule => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 border border-gray-200 rounded-xl p-3 flex items-center justify-between';
                div.innerHTML = `
                    <div>
                        <h4 class="font-bold text-gray-800">${rule.name}</h4>
                        <p class="text-xs text-gray-500 mt-1">
                            ğŸŒ¡ï¸ ${rule.tempMin == -999 ? '' : rule.tempMin + 'Â°C ~ '} ${rule.tempMax == 999 ? '' : rule.tempMax + 'Â°C'}
                            ${rule.humidMin > 0 ? ` | ğŸ’§ ${rule.humidMin}%` : ''}
                            ${rule.soilMin > 0 ? ` | ğŸŒ± ${rule.soilMin}%` : ''}
                        </p>
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="alert-switch">
                            <input type="checkbox" ${rule.enabled ? 'checked' : ''} data-id="${rule.id}" class="toggle-rule">
                            <span class="alert-slider"></span>
                        </label>
                        <button class="text-red-400 hover:text-red-600 delete-rule" data-id="${rule.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                `;
                alertListContainer.appendChild(div);
            });

            // Add event listeners for toggles and delete buttons
            document.querySelectorAll('.toggle-rule').forEach(toggle => {
                toggle.addEventListener('change', (e) => {
                    const id = parseInt(e.target.dataset.id);
                    const rule = alertRules.find(r => r.id === id);
                    if(rule) {
                        rule.enabled = e.target.checked;
                        saveRulesToStorage();
                    }
                });
            });

            document.querySelectorAll('.delete-rule').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = parseInt(e.currentTarget.dataset.id); // use currentTarget to get button not svg
                    if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        alertRules = alertRules.filter(r => r.id !== id);
                        saveRulesToStorage();
                        renderAlertList();
                    }
                });
            });
        }

        function showToast(message, type = 'error') {
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            // Different colors for types if needed, currently using red for alert default
            if (type === 'success') {
                toast.style.backgroundColor = '#dcfce7';
                toast.style.color = '#166534';
                toast.style.borderColor = '#bbf7d0';
                toast.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg><span>${message}</span>`;
            } else {
                toast.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg><span>${message}</span>`;
            }

            toastContainer.appendChild(toast);
            
            // Trigger reflow
            toast.offsetHeight; 
            
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function checkAlerts(temp, humidity, soil) {
            const now = Date.now();
            if (now - lastAlertTime < ALERT_COOLDOWN) return; // Skip if in cooldown

            // Check ALL enabled rules
            let violationFound = false;

            alertRules.forEach(rule => {
                if (!rule.enabled) return;

                let messages = [];
                if (temp > rule.tempMax) messages.push(`[${rule.name}] ì˜¨ë„ê°€ ë„ˆë¬´ ë†’ìŠµë‹ˆë‹¤! (${temp.toFixed(1)}Â°C)`);
                if (temp < rule.tempMin) messages.push(`[${rule.name}] ì˜¨ë„ê°€ ë„ˆë¬´ ë‚®ìŠµë‹ˆë‹¤! (${temp.toFixed(1)}Â°C)`);
                if (humidity < rule.humidMin) messages.push(`[${rule.name}] ìŠµë„ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤! (${humidity}%)`);
                if (soil < rule.soilMin) messages.push(`[${rule.name}] ë¬¼ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (${soil}%)`);

                if (messages.length > 0) {
                    showToast(messages[0]); // Show first violation per rule
                    violationFound = true;
                }
            });

            if (violationFound) {
                lastAlertTime = now;
            }
        }


        // --- Tab Logic (NEW) ---
        function setupTabs() {
            const tabs = [
                { button: tabControl, content: contentControl },
                { button: tabCrops, content: contentCrops },
                { button: tabEncyclopedia, content: contentEncyclopedia },
                { button: tabAi, content: contentAi },
                { button: tabStats, content: contentStats },
            ];

            tabs.forEach(tab => {
                tab.button.addEventListener('click', () => {
                    // Hide all contents
                    tabs.forEach(t => {
                        t.content.style.display = 'none';
                        t.button.classList.remove('text-blue-600', 'border-blue-600');
                        t.button.classList.add('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                    });

                    // Show selected content
                    tab.content.style.display = 'block';
                    tab.button.classList.remove('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                    tab.button.classList.add('text-blue-600', 'border-blue-600');
                    
                    // Resize charts if switching to stats or crops
                    if (tab.button === tabStats || tab.button === tabControl) {
                         window.dispatchEvent(new Event('resize'));
                    }
                });
            });
        }

        // --- Weather Logic (NEW) ---
        async function fetchWeather() {
            const weatherIconEl = document.getElementById('weather-icon');
            const weatherLocationEl = document.getElementById('weather-location');
            const weatherTempEl = document.getElementById('weather-temp');
            const weatherDescEl = document.getElementById('weather-desc');

            // Default location (Seoul)
            let lat = 37.5665;
            let lon = 126.9780;

            // Get User Location
            if (navigator.geolocation) {
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject);
                    });
                    lat = position.coords.latitude;
                    lon = position.coords.longitude;
                    
                    // Reverse Geocoding (Optional, free API)
                    try {
                        const geoRes = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=ko`);
                        const geoData = await geoRes.json();
                        weatherLocationEl.textContent = geoData.locality || geoData.city || "ë‚´ ìœ„ì¹˜";
                    } catch (e) {
                        weatherLocationEl.textContent = "ë‚´ ìœ„ì¹˜";
                    }

                } catch (error) {
                    console.log("Location access denied, using default (Seoul)");
                    weatherLocationEl.textContent = "ì„œìš¸";
                }
            }

            try {
                // Open-Meteo API (No Key Required)
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`);
                const data = await response.json();
                const weather = data.current_weather;
                
                weatherTempEl.textContent = `${weather.temperature}Â°C`;
                const wmo = getWeatherDescription(weather.weathercode);
                weatherDescEl.textContent = wmo.desc;
                weatherIconEl.textContent = wmo.icon;

            } catch (error) {
                console.error("Failed to fetch weather:", error);
                weatherDescEl.textContent = "ì •ë³´ ì—†ìŒ";
            }
        }

        function getWeatherDescription(code) {
            // WMO Weather interpretation codes (WW)
            const codes = {
                0: { desc: 'ë§‘ìŒ', icon: 'â˜€ï¸' },
                1: { desc: 'ëŒ€ì²´ë¡œ ë§‘ìŒ', icon: 'ğŸŒ¤ï¸' },
                2: { desc: 'êµ¬ë¦„ ì¡°ê¸ˆ', icon: 'â›…' },
                3: { desc: 'íë¦¼', icon: 'â˜ï¸' },
                45: { desc: 'ì•ˆê°œ', icon: 'ğŸŒ«ï¸' },
                48: { desc: 'ì•ˆê°œ', icon: 'ğŸŒ«ï¸' },
                51: { desc: 'ì´ìŠ¬ë¹„', icon: 'ğŸŒ§ï¸' },
                53: { desc: 'ì´ìŠ¬ë¹„', icon: 'ğŸŒ§ï¸' },
                55: { desc: 'ì´ìŠ¬ë¹„', icon: 'ğŸŒ§ï¸' },
                61: { desc: 'ë¹„', icon: 'â˜”' },
                63: { desc: 'ë¹„', icon: 'â˜”' },
                65: { desc: 'ë¹„', icon: 'â˜”' },
                71: { desc: 'ëˆˆ', icon: 'â˜ƒï¸' },
                73: { desc: 'ëˆˆ', icon: 'â˜ƒï¸' },
                75: { desc: 'ëˆˆ', icon: 'â˜ƒï¸' },
                95: { desc: 'ë‡Œìš°', icon: 'âš¡' },
                96: { desc: 'ë‡Œìš°', icon: 'âš¡' },
                99: { desc: 'ë‡Œìš°', icon: 'âš¡' },
            };
            return codes[code] || { desc: 'ì•Œ ìˆ˜ ì—†ìŒ', icon: 'â“' };
        }


        // --- Plant Encyclopedia Logic (NEW) ---
        function renderPlants(category = 'all', searchTerm = '') {
            plantListContainer.innerHTML = '';
            
            const filteredPlants = plantData.filter(plant => {
                const matchesCategory = category === 'all' || plant.category === category;
                const matchesSearch = plant.name.includes(searchTerm) || plant.desc.includes(searchTerm);
                return matchesCategory && matchesSearch;
            });

            if (filteredPlants.length === 0) {
                noPlantResultsEl.classList.remove('hidden');
            } else {
                noPlantResultsEl.classList.add('hidden');
                filteredPlants.forEach(plant => {
                    const plantCard = document.createElement('div');
                    plantCard.className = 'bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition';
                    plantCard.innerHTML = `
                        <div class="p-5">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <span class="text-3xl">${plant.icon}</span>
                                    <h4 class="text-lg font-bold text-gray-800">${plant.name}</h4>
                                </div>
                                <span class="text-xs font-semibold px-2 py-1 rounded-full bg-gray-100 text-gray-600">
                                    ${getCategoryName(plant.category)}
                                </span>
                            </div>
                            <p class="text-sm text-gray-500 mb-4 h-10 overflow-hidden">${plant.desc}</p>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div class="bg-red-50 p-2 rounded text-red-700 font-medium">
                                    ğŸŒ¡ï¸ ${plant.temp}
                                </div>
                                <div class="bg-blue-50 p-2 rounded text-blue-700 font-medium">
                                    ğŸ’§ ${plant.humidity}
                                </div>
                                <div class="bg-green-50 p-2 rounded text-green-700 font-medium">
                                    ğŸŒ± ${plant.soil}
                                </div>
                                <div class="bg-yellow-50 p-2 rounded text-yellow-700 font-medium">
                                    â˜€ï¸ ${plant.light}
                                </div>
                            </div>
                        </div>
                    `;
                    plantListContainer.appendChild(plantCard);
                });
            }
        }

        function getCategoryName(cat) {
            switch(cat) {
                case 'leaf': return 'ìì±„ì†Œ';
                case 'fruit': return 'ì—´ë§¤ì±„ì†Œ';
                case 'root': return 'ë¿Œë¦¬ì±„ì†Œ';
                case 'herb': return 'í—ˆë¸Œ/ê¸°íƒ€';
                default: return 'ê¸°íƒ€';
            }
        }

        // Category Filters
        categoryButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                categoryButtons.forEach(b => b.classList.remove('active', 'bg-blue-600', 'text-white'));
                btn.classList.add('active');
                currentPlantFilter = btn.dataset.category;
                renderPlants(currentPlantFilter, currentPlantSearch);
            });
        });

        // Search Logic
        plantSearchBtn.addEventListener('click', () => {
            currentPlantSearch = plantSearchInput.value.trim();
            renderPlants(currentPlantFilter, currentPlantSearch);
        });
        plantSearchInput.addEventListener('keyup', (e) => {
             if (e.key === 'Enter') {
                currentPlantSearch = plantSearchInput.value.trim();
                renderPlants(currentPlantFilter, currentPlantSearch);
             }
        });


        
        // --- Firestore Logic ---
        async function saveProfileToFirestore(profileName, profileData) {
            if (!currentUserId) return;
            await setDoc(doc(db, 'users', currentUserId, 'profiles', profileName), profileData);
        }

        async function deleteProfileFromFirestore(profileName) {
            if (!currentUserId) return;
            await deleteDoc(doc(db, 'users', currentUserId, 'profiles', profileName));
        }

        async function logDataToFirestore() {
            if (!currentUserId || !isConnected) return;
            try {
                const dataLog = {
                    temp: currentTemp,
                    humidity: currentHumidity,
                    soil: currentSoil,
                    light: currentLight,
                    timestamp: serverTimestamp()
                };
                await addDoc(collection(db, 'users', currentUserId, 'historicalData'), dataLog);
                console.log("Logged data to Firestore:", dataLog);
                // If currently viewing today's data, refresh the chart
                if (historyDatePicker.value === new Date().toISOString().split('T')[0]) {
                    fetchHistoryData(historyDatePicker.value);
                }
            } catch (error) {
                console.error("Error logging data:", error);
            }
        }
        
        function listenToProfiles(userId) {
            if (unsubscribeProfiles) unsubscribeProfiles();
            const profilesRef = collection(db, 'users', userId, 'profiles');
            unsubscribeProfiles = onSnapshot(profilesRef, (snapshot) => {
                const newProfiles = {};
                let hasProfiles = false;
                snapshot.forEach(doc => { newProfiles[doc.id] = doc.data(); hasProfiles = true; });
                
                if (!hasProfiles) {
                    const defaultProfile = { 'ê¸°ë³¸ ì„¤ì •': { icon: 'ğŸŒ±', targetHumidity: 65, targetSoil: 70 } };
                    saveProfileToFirestore('ê¸°ë³¸ ì„¤ì •', defaultProfile['ê¸°ë³¸ ì„¤ì •']);
                } else {
                    settingsProfiles = newProfiles;
                    updateProfileSelect();
                    const currentSelection = profileSelect.value;
                    if(settingsProfiles[currentSelection]){ applyProfile(currentSelection); }
                    else {
                        const firstProfileName = Object.keys(settingsProfiles)[0];
                        if (firstProfileName) { profileSelect.value = firstProfileName; applyProfile(firstProfileName); }
                    }
                    updateProfileSummary();
                }
            });
        }
        
        // --- App Logic ---
        function updateGauge(element, value, max) { const offset = circumference - (value / max) * circumference; element.style.strokeDashoffset = offset; }
        
        function createSensorChart(canvasId, label, color, min, max) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, { type: 'line', data: { labels: [], datasets: [{ label: label, data: [], borderColor: color, backgroundColor: color + '20', tension: 0.4, fill: true, pointBackgroundColor: color, pointRadius: 2, }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { min, max, ticks: { color: '#6b7280' } }, x: { ticks: { color: '#6b7280' } } }, plugins: { legend: { display: false } } } });
        }
        
        function initCharts() { tempChart = createSensorChart('tempChart', 'ì˜¨ë„', '#ef4444', 0, 50); humidityChart = createSensorChart('humidityChart', 'ìŠµë„', '#3b82f6', 0, 100); soilChart = createSensorChart('soilChart', 'í† ì–‘ ìˆ˜ë¶„', '#22c55e', 0, 100); lightChart = createSensorChart('lightChart', 'ì¡°ë„', '#f59e0b', 0, 2000); initHistoryChart();}
        
        function resetCharts() { [tempChart, humidityChart, soilChart, lightChart].forEach(chart => { if (chart) { chart.data.labels = []; chart.data.datasets[0].data = []; chart.update(); } }); }
        
        function addDataToCharts(temp, humidity, soil, light) {
            const charts = [tempChart, humidityChart, soilChart, lightChart]; const data = [temp, humidity, soil, light];
            const now = new Date(); const timeStr = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0') + ':' + String(now.getSeconds()).padStart(2, '0');
            charts.forEach((chart, index) => { if (!chart) return; const labels = chart.data.labels; labels.push(timeStr); chart.data.datasets[0].data.push(data[index]); if (labels.length > 15) { labels.shift(); chart.data.datasets[0].data.shift(); } chart.update('none'); });
        }

        function updateSensorData(temp, humidity, soil, light) {
            currentTemp = temp; currentHumidity = humidity; currentSoil = soil; currentLight = light;
            tempValueEl.textContent = `${currentTemp.toFixed(1)}â„ƒ`; humidityValueEl.textContent = `${currentHumidity.toFixed(0)}%`; soilValueEl.textContent = `${currentSoil.toFixed(0)}%`; lightValueEl.textContent = `${currentLight.toFixed(0)}lx`;
            updateGauge(tempProgressEl, currentTemp, 50); updateGauge(humidityProgressEl, currentHumidity, 100); updateGauge(soilProgressEl, currentSoil, 100); updateGauge(lightProgressEl, currentLight, 2000);
            updateProfileSummary(); addDataToCharts(temp, humidity, soil, light);
            checkAlerts(temp, humidity, soil); // Check alerts on update
        }

        function analyzePlantStatus(profile) {
             const issues = [];
             if (currentTemp < 10) issues.push("ì˜¨ë„ê°€ ë„ˆë¬´ ë‚®ìŠµë‹ˆë‹¤.");
             if (currentTemp > 35) issues.push("ì˜¨ë„ê°€ ë„ˆë¬´ ë†’ìŠµë‹ˆë‹¤.");
             if (currentSoil < profile.targetSoil - 20) issues.push("í† ì–‘ì´ ë„ˆë¬´ ê±´ì¡°í•©ë‹ˆë‹¤.");
             if (currentSoil > profile.targetSoil + 20) issues.push("í† ì–‘ì´ ë„ˆë¬´ ìŠµí•©ë‹ˆë‹¤.");

             if (issues.length === 0) return { status: 'good', message: 'ìµœì  í™˜ê²½ì…ë‹ˆë‹¤.' };
             return { status: 'warning', message: issues[0] }; 
        }

        function updateProfileSummary() {
            if (!profileSummaryList) return; profileSummaryList.innerHTML = ''; let activePumps = 0;
            if (Object.keys(settingsProfiles).length === 0) { profileSummaryList.innerHTML = '<p class="text-gray-500 text-sm col-span-full text-center">í”„ë¡œí•„ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>'; activePumpCountEl.textContent = '0'; return; }
            for (const profileName in settingsProfiles) {
                const profile = settingsProfiles[profileName]; const isPumpActive = currentSoil < profile.targetSoil; const icon = profile.icon || 'ğŸŒ±'; if (isPumpActive) activePumps++;
                const summaryCard = document.createElement('div');
                summaryCard.className = isPumpActive ? 'bg-white rounded-xl p-4 flex flex-col items-center text-center transition-all shadow-md border-2 border-blue-500' : 'bg-white rounded-xl p-4 flex flex-col items-center text-center transition-all shadow-sm border border-gray-200 hover:shadow-md';
                const pumpStatusHTML = isPumpActive ? `<div class="w-full mt-3 px-4 py-2 rounded-lg font-semibold text-sm bg-blue-100 text-blue-800 flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="animate-pulse"><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/></svg><span>ì‘ë™ì¤‘</span></div>` : `<div class="w-full mt-3 px-4 py-2 rounded-lg font-semibold text-sm bg-gray-100 text-gray-600 flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg><span>ëŒ€ê¸°ì¤‘</span></div>`;
                
                let aiBadge = '';
                if (isAIModeEnabled) {
                     const aiDiagnosis = analyzePlantStatus(profile);
                     let aiBadgeClass = aiDiagnosis.status === 'good' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700';
                     aiBadge = `<div class="${aiBadgeClass} text-xs px-2 py-1 rounded mt-1 w-full font-semibold">${aiDiagnosis.message}</div>`;
                }

                const cardTitle = document.createElement('h4');
                cardTitle.className = 'font-bold text-gray-800';
                cardTitle.textContent = profileName;

                const cardIcon = document.createElement('div');
                cardIcon.className = 'text-3xl mb-2';
                cardIcon.textContent = icon;

                summaryCard.appendChild(cardIcon);
                summaryCard.appendChild(cardTitle);
                summaryCard.innerHTML += aiBadge;
                
                // FIXED: Use .toFixed(1) to limit decimal places to 1
                summaryCard.innerHTML += `<p class="text-xs text-gray-500 mt-2">í˜„ì¬: ${Number(currentSoil).toFixed(1)}% / ê¸°ì¤€: ${profile.targetSoil}%</p>` + pumpStatusHTML;

                profileSummaryList.appendChild(summaryCard);
            }
            activePumpCountEl.textContent = activePumps; activePumpCountEl.classList.toggle('bg-blue-500', activePumps > 0); activePumpCountEl.classList.toggle('bg-gray-400', activePumps === 0);
        }

        aiModeToggle.addEventListener('click', () => {
            isAIModeEnabled = !isAIModeEnabled;
            const toggleKnob = aiModeToggle.querySelector('span');
            if (isAIModeEnabled) {
                aiModeToggle.classList.remove('bg-gray-200'); aiModeToggle.classList.add('bg-indigo-600');
                toggleKnob.classList.remove('translate-x-0'); toggleKnob.classList.add('translate-x-5');
            } else {
                aiModeToggle.classList.remove('bg-indigo-600'); aiModeToggle.classList.add('bg-gray-200');
                toggleKnob.classList.remove('translate-x-5'); toggleKnob.classList.add('translate-x-0');
            }
            updateProfileSummary();
        });

        function startSimulation() {
             if (simulationInterval) return; setConnected(true, 'simulation');
             simulationInterval = setInterval(() => { updateSensorData(fluctuate(currentTemp, 10, 40, 0.5), fluctuate(currentHumidity, 20, 90, 1), fluctuate(currentSoil, 10, 80, 0.8), fluctuate(currentLight, 100, 1500, 50)); }, 2000);
        }
        function stopSimulation() { if (simulationInterval) { clearInterval(simulationInterval); simulationInterval = null; } setConnected(false); }
        function fluctuate(value, min, max, amount) { let change = (Math.random() - 0.5) * amount; let newValue = value + change; return Math.max(min, Math.min(max, newValue)); }
        
        function setConnected(state, type = '') {
            isConnected = state;
            if (dataLogInterval) clearInterval(dataLogInterval);

            simulateBtn.disabled = isConnected && type === 'bluetooth';
            connectBtn.disabled = isConnected && type === 'simulation';
            [simulateBtn, connectBtn].forEach(btn => btn.classList.toggle('opacity-50', btn.disabled));
            [simulateBtn, connectBtn].forEach(btn => btn.classList.toggle('cursor-not-allowed', btn.disabled));
            
            const baseConnectHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8.7 15 12l3 3.3"/><path d="M6 12h9"/><path d="M9 8.7 12 12l-3 3.3"/><circle cx="12" cy="12" r="10"/></svg><span>ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°</span>`;
            const baseSimulateHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg><span>ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</span>`;
            
            if (state) {
                logDataToFirestore(); // Log immediately on connection start
                dataLogInterval = setInterval(logDataToFirestore, 10 * 60 * 1000); // Then every 10 minutes
                const btn = type === 'bluetooth' ? connectBtn : simulateBtn;
                const stopFn = type === 'bluetooth' ? disconnect : stopSimulation;
                btn.innerHTML = type === 'bluetooth' ? `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8.7 15 12l3 3.3"/><path d="m6 17.3-3-3.3 3-3.3"/><path d="M18 15.3 15 12l3-3.3"/><path d="m6 8.7 3 3.3-3 3.3"/><path d="M9 12h6"/></svg><span>ì—°ê²° í•´ì œ</span>` : `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="6" width="12" height="12" rx="2"></rect></svg><span>ì‹œë®¬ë ˆì´ì…˜ ì¤‘ì§€</span>`;
                btn.onclick = stopFn;
                btn.classList.remove('bg-blue-500', 'hover:bg-blue-600', 'bg-gray-500', 'hover:bg-gray-600');
                btn.classList.add('bg-red-500', 'hover:bg-red-600');
            } else {
                resetCharts();
                connectBtn.innerHTML = baseConnectHTML; connectBtn.onclick = connectBluetooth;
                simulateBtn.innerHTML = baseSimulateHTML; simulateBtn.onclick = startSimulation;
                connectBtn.classList.remove('bg-red-500', 'hover:bg-red-600'); connectBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                simulateBtn.classList.remove('bg-red-500', 'hover:bg-red-600'); simulateBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
            }
        }

        function connectBluetooth() {
            if (!navigator.bluetooth) { console.error('Web Bluetooth is not supported.'); return; }
            navigator.bluetooth.requestDevice({ filters: [{ services: ['0000ffe0-0000-1000-8000-00805f9b34fb'] }] })
            .then(d => { device = d; device.addEventListener('gattserverdisconnected', onDisconnected); return device.gatt.connect(); })
            .then(server => server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb'))
            .then(service => service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb'))
            .then(char => { characteristic = char; return characteristic.startNotifications(); })
            .then(() => { characteristic.addEventListener('characteristicvaluechanged', handleDataReceived); setConnected(true, 'bluetooth'); })
            .catch(error => { console.error('BT connection failed:', error); });
        }
        function disconnect() { if (device && device.gatt.connected) { device.gatt.disconnect(); } else if (simulationInterval) { stopSimulation(); } else { setConnected(false); } }
        function onDisconnected() { setConnected(false); console.log('BT disconnected.'); }
        function handleDataReceived(event) {
            const decoder = new TextDecoder('utf-8'); const dataString = decoder.decode(event.target.value);
            try {
                const temp = dataString.match(/T:([\d.]+)/)?.[1]; const humidity = dataString.match(/H:(\d+)/)?.[1];
                const soil = dataString.match(/S:(\d+)/)?.[1]; const light = dataString.match(/L:(\d+)/)?.[1];
                updateSensorData(parseFloat(temp || currentTemp), parseInt(humidity || currentHumidity), parseInt(soil || currentSoil), parseInt(light || currentLight));
            } catch (error) { console.error("Error parsing data:", error, "Received:", dataString); }
        }

        // --- Image Upload Logic ---
        uploadBtn.addEventListener('click', () => imageUpload.click());

        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    currentImageBase64 = event.target.result;
                    imagePreview.src = currentImageBase64;
                    imageName.textContent = file.name;
                    imagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        removeImageBtn.addEventListener('click', () => {
            currentImageBase64 = null;
            imageUpload.value = ''; // Reset file input
            imagePreviewContainer.classList.add('hidden');
        });

        // AI Chat Logic (Robust with Retries and Image Support)
        async function callGeminiAPI(message, base64Image = null) {
            if (!geminiApiKey) {
                addChatMessage("AI", "API Keyë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.");
                return;
            }
            
            const promptText = `
                ë‹¹ì‹ ì€ ìŠ¤ë§ˆíŠ¸íŒœ ì „ë¬¸ê°€ AIì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ì¹œì ˆí•˜ê²Œ ë‹µë³€í•´ì£¼ì„¸ìš”.
                ë‹µë³€ì€ í•µì‹¬ë§Œ ìš”ì•½í•´ì„œ ì§§ê³  ê°„ê²°í•˜ê²Œ í•´ì£¼ì„¸ìš”.
                
                **ì¤‘ìš”: ì´ë¯¸ ëŒ€í™” ì¤‘ì´ë¯€ë¡œ "ì•ˆë…•í•˜ì„¸ìš”" ê°™ì€ ì¸ì‚¬ë§ì´ë‚˜ "ì €ëŠ” ìŠ¤ë§ˆíŠ¸íŒœ ì „ë¬¸ê°€ AIì…ë‹ˆë‹¤" ê°™ì€ ìê¸°ì†Œê°œëŠ” ì ˆëŒ€ í•˜ì§€ ë§ˆì„¸ìš”. ë°”ë¡œ ë³¸ë¡ ìœ¼ë¡œ ë“¤ì–´ê°€ì„œ ë‹µë³€ë§Œ í•˜ì„¸ìš”.**
                
                [í˜„ì¬ ì„¼ì„œ ë°ì´í„°]
                ì˜¨ë„: ${currentTemp}Â°C
                ìŠµë„: ${currentHumidity}%
                í† ì–‘ ìˆ˜ë¶„: ${currentSoil}%
                ì¡°ë„: ${currentLight}lx
                
                [ì‚¬ìš©ì ì§ˆë¬¸]
                ${message}
            `;

            const parts = [{ text: promptText }];
            
            if (base64Image) {
                // Extract pure Base64 string (remove data:image/png;base64, prefix)
                const mimeType = base64Image.split(';')[0].split(':')[1];
                const data = base64Image.split(',')[1];
                
                parts.push({
                    inlineData: {
                        mimeType: mimeType,
                        data: data
                    }
                });
            }

            // Retry logic variables
            const maxRetries = 5;
            let retryCount = 0;
            let delay = 1000; // Start with 1 second

            // Helper function for delay
            const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            while (retryCount <= maxRetries) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: parts }] })
                    });

                    const data = await response.json();
                    
                    // Check for API errors inside the 200 OK response or non-200 status
                    if (!response.ok || data.error) {
                        const errorMessage = data.error ? data.error.message : response.statusText;
                        // If overloaded (503 or specific error message), throw to trigger retry
                        if (response.status === 503 || errorMessage.includes('overloaded')) {
                            throw new Error(errorMessage); // Throw to catch block for retry
                        }
                         // For other errors, throw to exit loop
                         throw new Error(errorMessage);
                    }

                    const aiResponse = data.candidates[0].content.parts[0].text;
                    addChatMessage("AI", aiResponse);
                    return; // Success, exit function

                } catch (error) {
                    // We don't log to console as per instructions
                    
                    if (retryCount === maxRetries) {
                        // Final failure
                        addChatMessage("AI", `ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ AI ì„œë²„ê°€ í˜¼ì¡í•˜ì—¬ ì‘ë‹µí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (ì˜¤ë¥˜: ${error.message})`);
                        return;
                    }

                    // Wait before next retry
                    await wait(delay);
                    delay *= 2; // Exponential backoff
                    retryCount++;
                }
            }
        }

        function addChatMessage(sender, text, imageSrc = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender.toLowerCase()}`;
            
            let avatar = 'ğŸ¤–';
            if (sender === 'User') avatar = 'ğŸ‘¤';

            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'chat-avatar';
            avatarDiv.textContent = avatar;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'chat-bubble';
            
            if (imageSrc) {
                const img = document.createElement('img');
                img.src = imageSrc;
                img.className = 'max-w-full h-40 object-cover rounded-lg mb-2 border border-gray-200 block';
                bubbleDiv.appendChild(img);
            }

            if (sender === 'AI') {
                // Parse Markdown using marked.js
                const textDiv = document.createElement('div');
                textDiv.innerHTML = marked.parse(text);
                bubbleDiv.appendChild(textDiv);
            } else {
                const textDiv = document.createElement('div');
                textDiv.textContent = text;
                bubbleDiv.appendChild(textDiv);
            }
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(bubbleDiv);

            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        sendChatBtn.addEventListener('click', () => {
            const message = chatInput.value.trim();
            // Allow sending if there is a message OR an image
            if (message || currentImageBase64) {
                // Display message immediately
                addChatMessage("User", message, currentImageBase64);
                
                // Call AI with image if available
                callGeminiAPI(message, currentImageBase64);
                
                // Reset inputs
                chatInput.value = '';
                if (currentImageBase64) {
                    currentImageBase64 = null;
                    imageUpload.value = '';
                    imagePreviewContainer.classList.add('hidden');
                }
            }
        });

        chatInput.addEventListener('keyup', (e) => {
             if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatBtn.click();
            }
        });

        // --- Chat Suggestion Logic (NEW) ---
        document.querySelectorAll('#chat-suggestions button').forEach(btn => {
            btn.addEventListener('click', () => {
                const message = btn.textContent.replace(/ [ğŸŒ±ğŸ’§ğŸ¥¬ğŸŒ¡ï¸]$/, ''); // Remove emoji for clean query if needed, though Gemini handles it.
                addChatMessage("User", btn.textContent); // Show full text with emoji
                callGeminiAPI(message); // Send clean or full text
            });
        });


        function updateProfileSelect() {
            const currentSelection = profileSelect.value; profileSelect.innerHTML = '';
            for (const profileName in settingsProfiles) { const option = document.createElement('option'); option.value = profileName; option.textContent = profileName; profileSelect.appendChild(option); }
            if (settingsProfiles[currentSelection]) { profileSelect.value = currentSelection; }
            deleteProfileBtn.disabled = Object.keys(settingsProfiles).length <= 1; deleteProfileBtn.classList.toggle('opacity-50', deleteProfileBtn.disabled); deleteProfileBtn.classList.toggle('cursor-not-allowed', deleteProfileBtn.disabled);
        }
        function selectIcon(icon) { selectedIcon = icon; document.querySelectorAll('.icon-picker-item').forEach(item => { item.classList.remove('selected'); if (item.textContent === icon) { item.classList.add('selected'); } }); }
        function applyProfile(profileName) {
            if (settingsProfiles[profileName]) {
                const profile = settingsProfiles[profileName];
                targetHumidity = profile.targetHumidity; targetSoil = profile.targetSoil;
                humidityInput.value = targetHumidity; soilInput.value = targetSoil;
                profileNameInput.value = profileName; selectIcon(profile.icon || 'ğŸŒ±'); updateProfileSummary();
            }
        }
        saveProfileBtn.addEventListener('click', () => {
            const profileName = profileNameInput.value.trim(); if (!profileName) { profileNameInput.focus(); return; }
            const profileData = { icon: selectedIcon, targetHumidity: parseInt(humidityInput.value), targetSoil: parseInt(soilInput.value) };
            saveProfileToFirestore(profileName, profileData);
        });
        deleteProfileBtn.addEventListener('click', () => {
            const selectedProfile = profileSelect.value; if (!selectedProfile || Object.keys(settingsProfiles).length <= 1) { return; }
            deleteProfileFromFirestore(selectedProfile);
        });
        profileSelect.addEventListener('change', () => { applyProfile(profileSelect.value); });
        iconPicker.addEventListener('click', (e) => { if (e.target.classList.contains('icon-picker-item')) { selectIcon(e.target.textContent); } });
        humidityInput.addEventListener('change', (e) => { let v=parseInt(e.target.value); v=isNaN(v)?0:Math.max(0,Math.min(100,v)); e.target.value=v; targetHumidity=v; });
        soilInput.addEventListener('change', (e) => { let v=parseInt(e.target.value); v=isNaN(v)?0:Math.max(0,Math.min(100,v)); e.target.value=v; targetSoil=v; updateProfileSummary(); });
        
        function initHistoryChart() {
            const ctx = document.getElementById('historyChart').getContext('2d');
            historyChart = new Chart(ctx, {
                type: 'line',
                data: { datasets: [
                    { label: 'ì˜¨ë„ (Â°C)', data: [], borderColor: '#ef4444', yAxisID: 'yPercent' },
                    { label: 'ìŠµë„ (%)', data: [], borderColor: '#3b82f6', yAxisID: 'yPercent' },
                    { label: 'í† ì–‘ ìˆ˜ë¶„ (%)', data: [], borderColor: '#22c55e', yAxisID: 'yPercent' },
                    { label: 'ì¡°ë„ (lx)', data: [], borderColor: '#f59e0b', yAxisID: 'yLight' },
                ]},
                options: { responsive: true, maintainAspectRatio: false, scales: { 
                    x: { type: 'time', time: { unit: 'hour' }, ticks: { color: '#6b7280' } },
                    yPercent: { type: 'linear', position: 'left', min: 0, max: 100, title: { display: true, text: 'ì˜¨ë„(â„ƒ) / ìŠµë„(%)' }, ticks: { color: '#6b7280' } },
                    yLight: { type: 'linear', position: 'right', min: 0, title: { display: true, text: 'ì¡°ë„(lx)' }, grid: { drawOnChartArea: false }, ticks: { color: '#6b7280' } },
                }}
            });
        }

        async function fetchHistoryData(date) {
            if (!currentUserId) return;
            const startOfDay = new Date(date);
            startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date(date);
            endOfDay.setHours(23, 59, 59, 999);

            const q = query(collection(db, 'users', currentUserId, 'historicalData'), 
                where('timestamp', '>=', Timestamp.fromDate(startOfDay)),
                where('timestamp', '<=', Timestamp.fromDate(endOfDay)),
                orderBy('timestamp')
            );
            
            const querySnapshot = await getDocs(q);
            const data = { temp: [], humidity: [], soil: [], light: [] };
            
            // Reset global data variable
            currentHistoryData = [];

            querySnapshot.forEach((doc) => {
                const docData = doc.data();
                const timestamp = docData.timestamp.toDate();
                
                // Store raw data for CSV
                currentHistoryData.push({
                    time: timestamp.toLocaleTimeString('ko-KR'),
                    temp: docData.temp,
                    humidity: docData.humidity,
                    soil: docData.soil,
                    light: docData.light
                });

                data.temp.push({ x: timestamp, y: docData.temp });
                data.humidity.push({ x: timestamp, y: docData.humidity });
                data.soil.push({ x: timestamp, y: docData.soil });
                data.light.push({ x: timestamp, y: docData.light });
            });

            if (querySnapshot.empty) {
                historyNoDataEl.style.display = 'flex';
                historyChart.data.datasets.forEach(ds => ds.data = []);
            } else {
                historyNoDataEl.style.display = 'none';
                historyChart.data.datasets[0].data = data.temp;
                historyChart.data.datasets[1].data = data.humidity;
                historyChart.data.datasets[2].data = data.soil;
                historyChart.data.datasets[3].data = data.light;
            }
            historyChart.update();
        }

        historyDatePicker.addEventListener('change', (e) => fetchHistoryData(e.target.value));

        downloadCsvBtn.addEventListener('click', () => {
            if (currentHistoryData.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ğŸ˜…');
                return;
            }

            // CSV Header
            let csvContent = "\uFEFFì‹œê°„,ì˜¨ë„(Â°C),ìŠµë„(%),í† ì–‘ ìˆ˜ë¶„(%),ì¡°ë„(lx)\n"; // BOM for Korean support

            // CSV Rows
            currentHistoryData.forEach(row => {
                csvContent += `${row.time},${row.temp},${row.humidity},${row.soil},${row.light}\n`;
            });

            // Create Blob and Download Link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `smartfarm_data_${historyDatePicker.value}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // --- Voice Control Logic (NEW) ---
        const voiceBtn = document.getElementById('voice-control-btn');
        let recognition = null;

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = () => {
                voiceBtn.classList.add('listening');
            };

            recognition.onend = () => {
                voiceBtn.classList.remove('listening');
            };

            recognition.onresult = (event) => {
                const command = event.results[0][0].transcript;
                console.log("Voice Command:", command);
                processVoiceCommand(command);
            };

            voiceBtn.addEventListener('click', () => {
                if (voiceBtn.classList.contains('listening')) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            });
        } else {
            voiceBtn.style.display = 'none'; // Hide if not supported
            console.log("Web Speech API not supported.");
        }

        function processVoiceCommand(command) {
            showToast(`ğŸ—£ï¸ ì¸ì‹ëœ ëª…ë ¹ì–´: "${command}"`, "success");

            if (command.includes("ë¬¼") && (command.includes("ì¤˜") || command.includes("ì£¼ê¸°"))) {
                // Simulate pump
                showToast("ğŸ’¦ íŒí”„ë¥¼ 10ì´ˆê°„ ì‘ë™í•©ë‹ˆë‹¤.", "success");
                speak("íŒí”„ë¥¼ ì‘ë™í•©ë‹ˆë‹¤.");
            } else if (command.includes("ì˜¨ë„")) {
                const msg = `í˜„ì¬ ì˜¨ë„ëŠ” ${currentTemp.toFixed(1)}ë„ ì…ë‹ˆë‹¤.`;
                showToast(msg, "success");
                speak(msg);
            } else if (command.includes("ìŠµë„")) {
                const msg = `í˜„ì¬ ìŠµë„ëŠ” ${currentHumidity}% ì…ë‹ˆë‹¤.`;
                showToast(msg, "success");
                speak(msg);
            } else if (command.includes("ìƒíƒœ") || command.includes("ë¸Œë¦¬í•‘")) {
                const msg = `í˜„ì¬ ì˜¨ë„ëŠ” ${currentTemp.toFixed(1)}ë„, ìŠµë„ëŠ” ${currentHumidity}% ì…ë‹ˆë‹¤.`;
                showToast(msg, "success");
                speak(msg);
            } else {
                const msg = "ì£„ì†¡í•´ìš”, ì´í•´í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
                showToast(msg, "error");
                speak(msg);
            }
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ko-KR';
                window.speechSynthesis.speak(utterance);
            }
        }

        // --- Initialize Everything ---
        initCharts();
        setupTabs(); // Start tab listeners
        renderPlants(); // Render initial plant list
        historyDatePicker.valueAsDate = new Date();
        fetchHistoryData(historyDatePicker.value);
        setConnected(false);
    </script>
</body>
</html>
