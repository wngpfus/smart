<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Farm Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the dashboard */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .gauge-circle-bg {
            fill: none;
            stroke: #e5e7eb; /* Gray-200 */
            stroke-width: 10;
        }
        .gauge-circle-progress {
            fill: none;
            stroke-width: 10;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 0.5s ease-in-out;
        }
        .pulse-animation {
            animation: pulse-frames 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-frames {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="text-gray-800 p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800">ğŸŒ¿ Smart Farm Dashboard</h1>
            <p class="text-center text-gray-600 mt-2">ì‹¤ì‹œê°„ ì„¼ì„œ ëª¨ë‹ˆí„°ë§ ë° ì œì–´ ì‹œìŠ¤í…œ</p>
        </header>

        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                <button id="tab-control" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-blue-600 border-blue-600">
                    ì œì–´
                </button>
                <button id="tab-stats" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">
                    í†µê³„
                </button>
            </nav>
        </div>

        <!-- Control Panel Content -->
        <div id="content-control">
            <!-- Connection Controls -->
            <div class="mb-6 bg-white p-4 rounded-2xl shadow-md border border-gray-200 flex flex-col sm:flex-row items-center justify-center gap-4">
                <button id="connectBtn" class="w-full sm:w-auto flex-1 bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-all flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8.7 15 12l3 3.3"/><path d="M6 12h9"/><path d="M9 8.7 12 12l-3 3.3"/><circle cx="12" cy="12" r="10"/></svg>
                    <span>ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°</span>
                </button>
                <button id="simulateBtn" class="w-full sm:w-auto flex-1 bg-gray-500 hover:bg-gray-600 active:bg-gray-700 text-white font-semibold py-3 px-6 rounded-xl transition-all flex items-center justify-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
                    <span>ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</span>
                </button>
            </div>

            <!-- Water Pump Status Card -->
            <div class="bg-white rounded-2xl shadow-md border border-gray-200 p-6">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="text-xl font-semibold text-gray-800 mb-1">ì›Œí„°íŒí”„ ìƒíƒœ</h3>
                  <p class="text-gray-500 text-sm">ìë™ ê¸‰ìˆ˜ ì‹œìŠ¤í…œ</p>
                </div>
                <div id="pumpStatus" class="px-6 py-3 rounded-full font-bold text-lg bg-gray-200 text-gray-700 transition-all">
                  â¸ï¸ ëŒ€ê¸°ì¤‘
                </div>
              </div>
              
              <div id="pumpMessage" style="display: none;" class="mt-4 p-4 bg-blue-50 rounded-xl">
                <p class="text-blue-800 text-sm">
                  í† ì–‘ ìˆ˜ë¶„ì´ 70% ë¯¸ë§Œì´ë¯€ë¡œ ìë™ìœ¼ë¡œ ë¬¼ì„ ê³µê¸‰í•˜ê³  ìˆìŠµë‹ˆë‹¤.
                </p>
              </div>
            </div>
        </div>
        
        <!-- Statistics Content (Hidden by default) -->
        <div id="content-stats" style="display: none;">
             <!-- Sensor Grid -->
            <main class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                
                <!-- Temperature Card -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200 flex flex-col items-center justify-between">
                    <div class="w-full flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">ì˜¨ë„</h2>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/></svg>
                    </div>
                    <div class="relative w-40 h-40">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="gauge-circle-bg" cx="50" cy="50" r="45"></circle>
                            <circle id="temp-progress" class="gauge-circle-progress stroke-red-500" cx="50" cy="50" r="45"></circle>
                        </svg>
                        <div id="temp-value" class="absolute inset-0 flex items-center justify-center text-3xl font-bold">--â„ƒ</div>
                    </div>
                    <p class="mt-4 text-gray-500 text-sm">í˜„ì¬ ì‹¤ë‚´ ì˜¨ë„</p>
                </div>

                <!-- Humidity Card (with Controls) -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200 flex flex-col items-center justify-between">
                    <div class="w-full flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">ìŠµë„</h2>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/></svg>
                    </div>
                    <div class="relative w-40 h-40">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="gauge-circle-bg" cx="50" cy="50" r="45"></circle>
                            <circle id="humidity-progress" class="gauge-circle-progress stroke-blue-500" cx="50" cy="50" r="45"></circle>
                        </svg>
                        <div id="humidity-value" class="absolute inset-0 flex items-center justify-center text-3xl font-bold">--%</div>
                    </div>
                     <div class="w-full mt-4 text-center">
                        <label for="humidity-slider" class="text-sm text-gray-600">ëª©í‘œ ìŠµë„ ì„¤ì •: <span id="humidity-setpoint-label" class="font-bold text-blue-600">65%</span></label>
                        <input id="humidity-slider" type="range" min="0" max="100" value="65" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
                    </div>
                </div>

                <!-- Soil Moisture Card -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200 flex flex-col items-center justify-between">
                    <div class="w-full flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">í† ì–‘ ìˆ˜ë¶„</h2>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><path d="M21.2,12.2C21.2,12.2,21.2,12.2,21.2,12.2C19.3,16,16,18.8,12,18.8S4.7,16,2.8,12.2c0,0,0,0,0,0c-1.8-3.9,0.3-7.5,1-8.6 C4.2,2.8,4.9,2.2,5.6,2.1c0,0,0,0,0.1,0C7.2,1.8,9.6,3.3,12,5.7c2.4-2.4,4.8-3.9,6.3-4.1c0,0,0.1,0,0.1,0c0.7,0.1,1.4,0.7,1.8,1.5 C20.9,4.7,23,8.3,21.2,12.2z"/><path d="M12,18.8v3.3"/></svg>
                    </div>
                    <div class="relative w-40 h-40">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="gauge-circle-bg" cx="50" cy="50" r="45"></circle>
                            <circle id="soil-progress" class="gauge-circle-progress stroke-green-500" cx="50" cy="50" r="45"></circle>
                        </svg>
                        <div id="soil-value" class="absolute inset-0 flex items-center justify-center text-3xl font-bold">--%</div>
                    </div>
                     <p class="mt-4 text-gray-500 text-sm">í† ì–‘ì˜ ìˆ˜ë¶„ í•¨ëŸ‰</p>
                </div>

                <!-- Light Intensity Card -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200 flex flex-col items-center justify-between">
                    <div class="w-full flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">ì¡°ë„</h2>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m4.93 19.07 1.41-1.41"/><path d="m17.66 6.34 1.41-1.41"/></svg>
                    </div>
                    <div class="relative w-40 h-40">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="gauge-circle-bg" cx="50" cy="50" r="45"></circle>
                            <circle id="light-progress" class="gauge-circle-progress stroke-yellow-500" cx="50" cy="50" r="45"></circle>
                        </svg>
                        <div id="light-value" class="absolute inset-0 flex items-center justify-center text-3xl font-bold">--lx</div>
                    </div>
                    <p class="mt-4 text-gray-500 text-sm">í˜„ì¬ ì¡°ë„ëŸ‰</p>
                </div>
            </main>
             <!-- Chart Card -->
            <div class="mt-6 bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">ì„¼ì„œ ë°ì´í„° ë³€í™” ì¶”ì´</h3>
                <div class="h-80">
                    <canvas id="sensorChart"></canvas>
                </div>
            </div>
        </div>
        
    </div>

    <script>
        // DOM Elements
        const tabControl = document.getElementById('tab-control');
        const tabStats = document.getElementById('tab-stats');
        const contentControl = document.getElementById('content-control');
        const contentStats = document.getElementById('content-stats');

        const tempValueEl = document.getElementById('temp-value');
        const tempProgressEl = document.getElementById('temp-progress');
        const humidityValueEl = document.getElementById('humidity-value');
        const humidityProgressEl = document.getElementById('humidity-progress');
        const soilValueEl = document.getElementById('soil-value');
        const soilProgressEl = document.getElementById('soil-progress');
        const lightValueEl = document.getElementById('light-value');
        const lightProgressEl = document.getElementById('light-progress');
        const humiditySlider = document.getElementById('humidity-slider');
        const humiditySetpointLabel = document.getElementById('humidity-setpoint-label');
        const connectBtn = document.getElementById('connectBtn');
        const simulateBtn = document.getElementById('simulateBtn');
        const pumpStatusEl = document.getElementById('pumpStatus');
        const pumpMessageEl = document.getElementById('pumpMessage');

        // Bluetooth State
        let device = null;
        let characteristic = null;
        let isConnected = false;
        let simulationInterval = null;

        // Chart.js State
        let sensorChart = null;

        // Gauge circle circumference
        const circumference = 2 * Math.PI * 45;

        // Set initial stroke-dasharray
        [tempProgressEl, humidityProgressEl, soilProgressEl, lightProgressEl].forEach(el => {
            el.style.strokeDasharray = circumference;
            el.style.strokeDashoffset = circumference;
        });

        function updateGauge(element, value, max) {
            const offset = circumference - (value / max) * circumference;
            element.style.strokeDashoffset = offset;
        }

        // State for sensor values
        // Set more realistic initial values for simulation
        let currentTemp = 25.0;
        let currentHumidity = 60;
        let currentSoil = 55;
        let currentLight = 800;
        let targetHumidity = 65;

        // --- Chart Functions ---
        function initChart() {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            sensorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'ì˜¨ë„ (Â°C)',
                            data: [],
                            borderColor: '#ef4444', // red-500
                            backgroundColor: '#ef444420',
                            yAxisID: 'yPercent',
                            tension: 0.4,
                            fill: true,
                        },
                        {
                            label: 'ìŠµë„ (%)',
                            data: [],
                            borderColor: '#3b82f6', // blue-500
                            backgroundColor: '#3b82f620',
                            yAxisID: 'yPercent',
                            tension: 0.4,
                            fill: true,
                        },
                        {
                            label: 'í† ì–‘ ìˆ˜ë¶„ (%)',
                            data: [],
                            borderColor: '#22c55e', // green-500
                            backgroundColor: '#22c55e20',
                            yAxisID: 'yPercent',
                            tension: 0.4,
                            fill: true,
                        },
                        {
                            label: 'ì¡°ë„ (lx)',
                            data: [],
                            borderColor: '#f59e0b', // amber-500
                            backgroundColor: '#f59e0b20',
                            yAxisID: 'yLight',
                            tension: 0.4,
                            fill: true,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: '#6b7280' } },
                        yPercent: {
                            type: 'linear',
                            position: 'left',
                            min: 0,
                            max: 100,
                            title: { display: true, text: 'ì˜¨ë„(â„ƒ) / ìŠµë„(%)', color: '#6b7280' },
                            ticks: { color: '#6b7280' }
                        },
                        yLight: {
                            type: 'linear',
                            position: 'right',
                            min: 0,
                            max: 2000,
                            title: { display: true, text: 'ì¡°ë„ (lx)', color: '#6b7280' },
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#6b7280' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#374151' } }
                    }
                }
            });
        }

        function resetChart() {
            if (!sensorChart) return;
            sensorChart.data.labels = [];
            sensorChart.data.datasets.forEach(dataset => {
                dataset.data = [];
            });
            sensorChart.update();
        }

        function addDataToChart(temp, humidity, soil, light) {
            if (!sensorChart) return;

            const labels = sensorChart.data.labels;
            const now = new Date();
            const timeStr = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0') + ':' + String(now.getSeconds()).padStart(2, '0');
            
            labels.push(timeStr);
            sensorChart.data.datasets[0].data.push(temp);
            sensorChart.data.datasets[1].data.push(humidity);
            sensorChart.data.datasets[2].data.push(soil);
            sensorChart.data.datasets[3].data.push(light);

            if (labels.length > 15) {
                labels.shift();
                sensorChart.data.datasets.forEach(dataset => {
                    dataset.data.shift();
                });
            }

            sensorChart.update();
        }


        // Main data update function
        function updateSensorData(temp, humidity, soil, light) {
            currentTemp = temp;
            currentHumidity = humidity;
            currentSoil = soil;
            currentLight = light;

            tempValueEl.textContent = `${currentTemp.toFixed(1)}â„ƒ`;
            humidityValueEl.textContent = `${currentHumidity.toFixed(0)}%`;
            soilValueEl.textContent = `${currentSoil.toFixed(0)}%`;
            lightValueEl.textContent = `${currentLight.toFixed(0)}lx`;

            updateGauge(tempProgressEl, currentTemp, 50);
            updateGauge(humidityProgressEl, currentHumidity, 100);
            updateGauge(soilProgressEl, currentSoil, 100);
            updateGauge(lightProgressEl, currentLight, 2000);

            updatePumpStatus(currentSoil < 70);
            addDataToChart(temp, humidity, soil, light);
        }

        function updatePumpStatus(isPumpActive) {
            if (isPumpActive) {
                pumpStatusEl.className = 'px-6 py-3 rounded-full font-bold text-lg bg-blue-500 text-white pulse-animation transition-all';
                pumpStatusEl.textContent = 'ğŸš° ì‘ë™ì¤‘';
                pumpMessageEl.style.display = 'block';
            } else {
                pumpStatusEl.className = 'px-6 py-3 rounded-full font-bold text-lg bg-gray-200 text-gray-700 transition-all';
                pumpStatusEl.textContent = 'â¸ï¸ ëŒ€ê¸°ì¤‘';
                pumpMessageEl.style.display = 'none';
            }
        }

        // --- Bluetooth Functions ---
        function connectBluetooth() {
            if (!navigator.bluetooth) {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ì›¹ ë¸”ë£¨íˆ¬ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome ì´ë‚˜ Edge ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                return;
            }
            navigator.bluetooth.requestDevice({
                filters: [{ services: ['0000ffe0-0000-1000-8000-00805f9b34fb'] }],
                optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb']
            })
            .then(d => {
                device = d;
                device.addEventListener('gattserverdisconnected', onDisconnected);
                return device.gatt.connect();
            })
            .then(server => server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb'))
            .then(service => service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb'))
            .then(char => {
                characteristic = char;
                return characteristic.startNotifications();
            })
            .then(() => {
                characteristic.addEventListener('characteristicvaluechanged', handleDataReceived);
                setConnected(true, 'bluetooth');
                alert('ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ì„±ê³µ!');
            })
            .catch(error => {
                console.error('ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ì‹¤íŒ¨:', error);
                alert('ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            });
        }

        function disconnect() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            } else if (simulationInterval) {
                stopSimulation();
            } else {
                setConnected(false);
            }
        }

        function onDisconnected() {
            setConnected(false);
            alert('ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
        }

        function handleDataReceived(event) {
            const value = event.target.value;
            const decoder = new TextDecoder('utf-8');
            const dataString = decoder.decode(value);
            
            try {
                const tempMatch = dataString.match(/T:([\d.]+)/);
                const humidityMatch = dataString.match(/H:(\d+)/);
                const soilMatch = dataString.match(/S:(\d+)/);
                const lightMatch = dataString.match(/L:(\d+)/);

                const temp = tempMatch ? parseFloat(tempMatch[1]) : currentTemp;
                const humidity = humidityMatch ? parseInt(humidityMatch[1]) : currentHumidity;
                const soil = soilMatch ? parseInt(soilMatch[1]) : currentSoil;
                const light = lightMatch ? parseInt(lightMatch[1]) : currentLight;

                updateSensorData(temp, humidity, soil, light);
            } catch (error) {
                console.error("Error parsing data:", error, "Received:", dataString);
            }
        }

        // --- Simulation Functions ---
        function startSimulation() {
            if (simulationInterval) return;
            setConnected(true, 'simulation');
            
            simulationInterval = setInterval(() => {
                const temp = fluctuate(currentTemp, 10, 40, 0.5);
                const humidity = fluctuate(currentHumidity, 20, 90, 1);
                const soil = fluctuate(currentSoil, 10, 80, 0.8);
                const light = fluctuate(currentLight, 100, 1500, 50);
                updateSensorData(temp, humidity, soil, light);
            }, 2000);
        }

        function stopSimulation() {
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
            }
            setConnected(false);
        }

        function fluctuate(value, min, max, amount) {
            let change = (Math.random() - 0.5) * amount;
            let newValue = value + change;
            return Math.max(min, Math.min(max, newValue));
        }

        // --- UI Control ---
        function setConnected(state, type = '') {
            isConnected = state;
            if (state) {
                if (type === 'bluetooth') {
                    simulateBtn.disabled = true;
                    simulateBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    connectBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8.7 15 12l3 3.3"/><path d="m6 17.3-3-3.3 3-3.3"/><path d="M18 15.3 15 12l3-3.3"/><path d="m6 8.7 3 3.3-3 3.3"/><path d="M9 12h6"/></svg>
                        <span>ì—°ê²° í•´ì œ</span>`;
                    connectBtn.onclick = disconnect;
                    connectBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    connectBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                } else if (type === 'simulation') {
                    connectBtn.disabled = true;
                    connectBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    simulateBtn.innerHTML = `
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="6" width="12" height="12" rx="2"></rect></svg>
                         <span>ì‹œë®¬ë ˆì´ì…˜ ì¤‘ì§€</span>`;
                    simulateBtn.onclick = stopSimulation;
                    simulateBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                    simulateBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                }
            } else {
                updatePumpStatus(false);
                resetChart();
                connectBtn.disabled = false;
                connectBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-red-500', 'hover:bg-red-600');
                connectBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                connectBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8.7 15 12l3 3.3"/><path d="M6 12h9"/><path d="M9 8.7 12 12l-3 3.3"/><circle cx="12" cy="12" r="10"/></svg>
                    <span>ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°</span>`;
                connectBtn.onclick = connectBluetooth;

                simulateBtn.disabled = false;
                simulateBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-red-500', 'hover:bg-red-600');
                simulateBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
                simulateBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
                    <span>ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</span>`;
                simulateBtn.onclick = startSimulation;
            }
        }
        
        // --- Tab Controls ---
        tabControl.addEventListener('click', () => {
            contentControl.style.display = 'block';
            contentStats.style.display = 'none';

            tabControl.classList.add('text-blue-600', 'border-blue-600');
            tabControl.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');
            
            tabStats.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');
            tabStats.classList.remove('text-blue-600', 'border-blue-600');
        });

        tabStats.addEventListener('click', () => {
            contentStats.style.display = 'block';
            contentControl.style.display = 'none';
            
            tabStats.classList.add('text-blue-600', 'border-blue-600');
            tabStats.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');

            tabControl.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');
            tabControl.classList.remove('text-blue-600', 'border-blue-600');
        });

        // --- Other Event Listeners ---
        humiditySlider.addEventListener('input', (e) => {
            targetHumidity = parseInt(e.target.value);
            humiditySetpointLabel.textContent = `${targetHumidity}%`;
        });

        // --- Initializations ---
        initChart();
        setConnected(false); // Set initial button states and event listeners

    </script>
</body>
</html>

