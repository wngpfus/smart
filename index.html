<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#10b981">
  <meta name="description" content="ìŠ¤ë§ˆíŠ¸íŒœ ìë™ ê¸‰ìˆ˜ ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ì•±">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ìŠ¤ë§ˆíŠ¸íŒœ">
  <title>ìŠ¤ë§ˆíŠ¸íŒœ ëª¨ë‹ˆí„°ë§</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3EğŸŒ±%3C/text%3E%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3EğŸŒ±%3C/text%3E%3C/svg%3E">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      touch-action: pan-y;
      overscroll-behavior-y: contain;
      -webkit-tap-highlight-color: transparent;
    }
    
    .pulse-animation {
      animation: pulse-frames 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse-frames {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    .install-prompt {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
    }

    .install-prompt.show {
      display: block;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from { transform: translateY(100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    button {
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50">
  
  <div id="installPrompt" class="install-prompt">
    <div class="flex items-start gap-3">
      <div class="text-2xl">ğŸ“±</div>
      <div class="flex-1">
        <p class="font-bold text-gray-800 mb-1">í™ˆí™”ë©´ì— ì¶”ê°€í•˜ê¸°</p>
        <p class="text-sm text-gray-600 mb-3">ìŠ¤ë§ˆíŠ¸íŒœ ì•±ì„ í™ˆí™”ë©´ì— ì¶”ê°€í•˜ì—¬ ë¹ ë¥´ê²Œ ì ‘ì†í•˜ì„¸ìš”!</p>
        <div class="flex gap-2">
          <button onclick="installApp()" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg font-semibold text-sm active:bg-green-600">ì„¤ì¹˜í•˜ê¸°</button>
          <button onclick="closeInstallPrompt()" class="px-4 py-2 text-gray-600 text-sm active:bg-gray-100 rounded-lg">ë‚˜ì¤‘ì—</button>
        </div>
      </div>
    </div>
  </div>

  <div class="min-h-screen p-4">
    <div class="max-w-4xl mx-auto pb-20">
      
      <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸŒ± ìŠ¤ë§ˆíŠ¸íŒœ ëª¨ë‹ˆí„°ë§</h1>
            <p class="text-gray-600">ìë™ ê¸‰ìˆ˜ ì‹œìŠ¤í…œ ì œì–´</p>
          </div>
          <div class="text-4xl">ğŸ’§</div>
        </div>

        <div class="flex gap-3">
          <button id="connectBtn" onclick="connectBluetooth()" class="flex-1 bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-all">
            ğŸ“¡ ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°
          </button>
          <button id="simulateBtn" onclick="startSimulation()" class="flex-1 bg-gray-500 hover:bg-gray-600 active:bg-gray-700 text-white font-semibold py-3 px-6 rounded-xl transition-all">
            âš¡ ì‹œë®¬ë ˆì´ì…˜
          </button>
        </div>
      </div>

      <div id="connectedView" style="display: none;">
        
        <div id="humidityCard" class="bg-green-50 border-2 border-green-200 rounded-2xl shadow-lg p-8 mb-6 transition-all">
          <div class="text-center">
            <p class="text-gray-600 font-semibold mb-2">í˜„ì¬ í† ì–‘ ìŠµë„</p>
            <div id="humidityValue" class="text-7xl font-bold text-green-500 mb-4">0%</div>
            <div id="humidityStatus" class="flex items-center justify-center gap-2">
              <span class="text-green-600 font-semibold">ğŸ’§ ìŠµë„ ì ì •</span>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-xl font-bold text-gray-800 mb-2">ì›Œí„°íŒí”„ ìƒíƒœ</h3>
              <p class="text-gray-600">ìë™ ê¸‰ìˆ˜ ì‹œìŠ¤í…œ</p>
            </div>
            <div id="pumpStatus" class="px-6 py-3 rounded-full font-bold text-lg bg-gray-200 text-gray-600">
              â¸ï¸ ëŒ€ê¸°ì¤‘
            </div>
          </div>
          
          <div id="pumpMessage" style="display: none;" class="mt-4 p-4 bg-blue-50 rounded-xl">
            <p class="text-blue-800 text-sm">
              í† ì–‘ ìŠµë„ê°€ 70% ë¯¸ë§Œì´ë¯€ë¡œ ìë™ìœ¼ë¡œ ë¬¼ì„ ê³µê¸‰í•˜ê³  ìˆìŠµë‹ˆë‹¤.
            </p>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6">
          <div class="flex items-center gap-2 mb-4">
            <span class="text-2xl">ğŸ“ˆ</span>
            <h3 class="text-xl font-bold text-gray-800">ìŠµë„ ë³€í™” ì¶”ì´</h3>
          </div>
          <canvas id="humidityChart" style="max-height: 250px;"></canvas>
          <div class="mt-4 p-4 bg-gray-50 rounded-xl">
            <p class="text-sm text-gray-600">
              ğŸ’¡ <strong>ìë™ ê¸‰ìˆ˜ ê¸°ì¤€:</strong> ìŠµë„ 70% ë¯¸ë§Œ ì‹œ ê¸‰ìˆ˜ ì‹œì‘, 70% ì´ìƒ ì‹œ ê¸‰ìˆ˜ ì¤‘ë‹¨
            </p>
          </div>
        </div>
      </div>

      <div id="disconnectedView" class="bg-white rounded-2xl shadow-lg p-8 text-center">
        <div class="text-6xl mb-4">ğŸ“¡</div>
        <h3 class="text-xl font-bold text-gray-800 mb-2">ë¸”ë£¨íˆ¬ìŠ¤ë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”</h3>
        <p class="text-gray-600 mb-4">
          ì•„ë‘ì´ë…¸ ìŠ¤ë§ˆíŠ¸íŒœ ê¸°ê¸°ì™€ ì—°ê²°í•˜ì—¬ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ì„ ì‹œì‘í•˜ì„¸ìš”.
        </p>
        <div class="text-left bg-blue-50 p-4 rounded-xl text-sm text-gray-700">
          <p class="font-semibold mb-2">ğŸ“Œ ì—°ê²° ë°©ë²•:</p>
          <ol class="list-decimal list-inside space-y-1">
            <li>ë¸”ë£¨íˆ¬ìŠ¤ ëª¨ë“ˆ(HC-05/HC-06 ë˜ëŠ” HM-10)ì´ ì•„ë‘ì´ë…¸ì— ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸</li>
            <li>Chrome ë˜ëŠ” Edge ë¸Œë¼ìš°ì € ì‚¬ìš©</li>
            <li>'ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°' ë²„íŠ¼ í´ë¦­</li>
            <li>ê¸°ê¸° ëª©ë¡ì—ì„œ ìŠ¤ë§ˆíŠ¸íŒœ ì¥ì¹˜ ì„ íƒ</li>
          </ol>
          <p class="mt-3 text-xs text-gray-500">
            * í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ 'ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ'ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        </div>
      </div>

    </div>
  </div>

  <script>
    var isConnected = false;
    var device = null;
    var characteristic = null;
    var simulationInterval = null;
    var chart = null;
    var chartData = [];
    var deferredPrompt = null;

    window.addEventListener('beforeinstallprompt', function(e) {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installPrompt').classList.add('show');
    });

    function installApp() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(function(choiceResult) {
          if (choiceResult.outcome === 'accepted') {
            console.log('ì•± ì„¤ì¹˜ ì™„ë£Œ');
          }
          deferredPrompt = null;
          closeInstallPrompt();
        });
      }
    }

    function closeInstallPrompt() {
      document.getElementById('installPrompt').classList.remove('show');
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js')
          .then(function() { console.log('Service Worker ë“±ë¡ ì™„ë£Œ'); })
          .catch(function(err) { console.error('Service Worker ë“±ë¡ ì‹¤íŒ¨:', err); });
      });
    }

    function initChart() {
      var ctx = document.getElementById('humidityChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'ìŠµë„ (%)',
            data: [],
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 3,
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          }
        }
      });
    }

    function connectBluetooth() {
      if (!navigator.bluetooth) {
        alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ë¸”ë£¨íˆ¬ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nChromeì´ë‚˜ Edgeë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
        return;
      }

      navigator.bluetooth.requestDevice({
        filters: [
          { services: ['0000ffe0-0000-1000-8000-00805f9b34fb'] }
        ],
        optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb']
      })
      .then(function(d) {
        device = d;
        return device.gatt.connect();
      })
      .then(function(server) {
        return server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
      })
      .then(function(service) {
        return service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
      })
      .then(function(char) {
        characteristic = char;
        return characteristic.startNotifications();
      })
      .then(function() {
        characteristic.addEventListener('characteristicvaluechanged', handleDataReceived);
        setConnected(true);
        alert('ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ì„±ê³µ! âœ…');
      })
      .catch(function(error) {
        console.error('ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ì‹¤íŒ¨:', error);
        alert('ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ì‹¤íŒ¨: ' + error.message);
      });
    }

    function handleDataReceived(event) {
      var value = event.target.value;
      var decoder = new TextDecoder('utf-8');
      var data = decoder.decode(value);
      
      var humidityMatch = data.match(/H:(\d+)/);
      var pumpMatch = data.match(/P:(\d+)/);
      
      if (humidityMatch) {
        var humidity = parseInt(humidityMatch[1]);
        updateHumidity(humidity);
      }
      
      if (pumpMatch) {
        var isPumpActive = pumpMatch[1] === '1';
        updatePumpStatus(isPumpActive);
      }
    }

    function startSimulation() {
      if (simulationInterval) {
        clearInterval(simulationInterval);
      }
      
      setConnected(true);
      
      simulationInterval = setInterval(function() {
        var humidity = Math.floor(Math.random() * 40) + 50;
        updateHumidity(humidity);
        updatePumpStatus(humidity < 70);
      }, 2000);
    }

    function setConnected(connected) {
      isConnected = connected;
      document.getElementById('connectedView').style.display = connected ? 'block' : 'none';
      document.getElementById('disconnectedView').style.display = connected ? 'none' : 'block';
      
      if (connected && !chart) {
        setTimeout(function() { initChart(); }, 100);
      }
      
      if (connected) {
        document.getElementById('connectBtn').textContent = 'ğŸ”Œ ì—°ê²° í•´ì œ';
        document.getElementById('connectBtn').onclick = disconnect;
      } else {
        document.getElementById('connectBtn').textContent = 'ğŸ“¡ ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°';
        document.getElementById('connectBtn').onclick = connectBluetooth;
      }
    }

    function disconnect() {
      if (device && device.gatt.connected) {
        device.gatt.disconnect();
      }
      if (simulationInterval) {
        clearInterval(simulationInterval);
        simulationInterval = null;
      }
      setConnected(false);
      chartData = [];
    }

    function updateHumidity(humidity) {
      var humidityCard = document.getElementById('humidityCard');
      var humidityValue = document.getElementById('humidityValue');
      var humidityStatus = document.getElementById('humidityStatus');
      
      humidityValue.textContent = humidity + '%';
      
      if (humidity < 70) {
        humidityCard.className = 'bg-red-50 border-2 border-red-200 rounded-2xl shadow-lg p-8 mb-6 transition-all';
        humidityValue.className = 'text-7xl font-bold text-red-500 mb-4';
        humidityStatus.innerHTML = '<span class="text-red-600 font-semibold">âš ï¸ ìŠµë„ ë¶€ì¡± - ê¸‰ìˆ˜ í•„ìš”</span>';
      } else if (humidity < 80) {
        humidityCard.className = 'bg-yellow-50 border-2 border-yellow-200 rounded-2xl shadow-lg p-8 mb-6 transition-all';
        humidityValue.className = 'text-7xl font-bold text-yellow-500 mb-4';
        humidityStatus.innerHTML = '<span class="text-yellow-600 font-semibold">ğŸ’§ ìŠµë„ ì ì •</span>';
      } else {
        humidityCard.className = 'bg-green-50 border-2 border-green-200 rounded-2xl shadow-lg p-8 mb-6 transition-all';
        humidityValue.className = 'text-7xl font-bold text-green-500 mb-4';
        humidityStatus.innerHTML = '<span class="text-green-600 font-semibold">ğŸ’§ ìŠµë„ ì¶©ë¶„</span>';
      }
      
      if (chart) {
        var now = new Date();
        var timeStr = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');
        
        chartData.push({ time: timeStr, humidity: humidity });
        if (chartData.length > 10) chartData.shift();
        
        chart.data.labels = chartData.map(function(d) { return d.time; });
        chart.data.datasets[0].data = chartData.map(function(d) { return d.humidity; });
        chart.update();
      }
    }

    function updatePumpStatus(isPumpActive) {
      var pumpStatus = document.getElementById('pumpStatus');
      var pumpMessage = document.getElementById('pumpMessage');
      
      if (isPumpActive) {
        pumpStatus.className = 'px-6 py-3 rounded-full font-bold text-lg bg-blue-500 text-white pulse-animation';
        pumpStatus.textContent = 'ğŸš° ì‘ë™ì¤‘';
        pumpMessage.style.display = 'block';
      } else {
        pumpStatus.className = 'px-6 py-3 rounded-full font-bold text-lg bg-gray-200 text-gray-600';
        pumpStatus.textContent = 'â¸ï¸ ëŒ€ê¸°ì¤‘';
        pumpMessage.style.display = 'none';
      }
    }
  </script>

</body>
</html>
