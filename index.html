<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Farm Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .gauge-circle-bg { fill: none; stroke: #e5e7eb; stroke-width: 10; }
        .gauge-circle-progress { fill: none; stroke-width: 10; stroke-linecap: round; transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 0.5s ease-in-out; }
        .pulse-animation { animation: pulse-frames 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse-frames { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .icon-picker-item.selected { border-color: #3b82f6; transform: scale(1.1); }
    </style>
</head>
<body class="text-gray-800">

    <!-- Authentication Screen -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">ğŸŒ¿</h1>
                <h2 class="text-2xl font-bold text-gray-800 mt-2">Smart Farm ë¡œê·¸ì¸</h2>
                <p class="text-gray-500 mt-2">í™˜ì˜í•©ë‹ˆë‹¤! ê³„ì •ì— ë¡œê·¸ì¸í•˜ê±°ë‚˜ ìƒˆë¡œ ë§Œë“œì„¸ìš”.</p>
            </div>

            <!-- Login / Signup Forms -->
            <form id="login-form">
                <div class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700">ì´ë©”ì¼</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <p id="auth-error" class="text-red-500 text-sm mt-4 h-5"></p>
                <div class="mt-6 flex flex-col sm:flex-row gap-3">
                    <button type="submit" id="login-btn" class="flex-1 w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">ë¡œê·¸ì¸</button>
                    <button type="button" id="signup-btn" class="flex-1 w-full flex justify-center py-3 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">íšŒì›ê°€ì…</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App Container (hidden by default) -->
    <div id="app-container" style="display: none;" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="mb-8">
             <div class="flex justify-between items-center">
                <div></div> <!-- Placeholder for spacing -->
                <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800">ğŸŒ¿ Smart Farm Dashboard</h1>
                <div class="text-right">
                    <p id="user-email" class="text-sm text-gray-600 font-medium"></p>
                    <button id="logout-btn" class="text-sm text-red-500 hover:underline">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </header>

        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                <button id="tab-control" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-blue-600 border-blue-600">ì œì–´</button>
                <button id="tab-stats" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">í†µê³„</button>
            </nav>
        </div>

        <!-- Control Panel Content -->
        <div id="content-control">
            <!-- Connection Controls -->
            <div class="mb-6 bg-white p-4 rounded-2xl shadow-md border border-gray-200 flex flex-col sm:flex-row items-center justify-center gap-4">
                <button id="connectBtn" class="w-full sm:w-auto flex-1 bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-all flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8.7 15 12l3 3.3"/><path d="M6 12h9"/><path d="M9 8.7 12 12l-3 3.3"/><circle cx="12" cy="12" r="10"/></svg>
                    <span>ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°</span>
                </button>
                <button id="simulateBtn" class="w-full sm:w-auto flex-1 bg-gray-500 hover:bg-gray-600 active:bg-gray-700 text-white font-semibold py-3 px-6 rounded-xl transition-all flex items-center justify-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
                    <span>ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</span>
                </button>
            </div>

            <!-- Profile Pump Status Summary -->
            <div class="bg-white rounded-2xl shadow-md border border-gray-200 p-6">
                <div class="flex items-center gap-3 mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">ì‘ë¬¼ íŒí”„ ìƒíƒœ</h3>
                    <span id="active-pump-count" class="flex items-center justify-center w-7 h-7 text-sm font-bold text-white bg-gray-400 rounded-full transition-colors">0</span>
                </div>
                <div id="profile-summary-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- JS will populate this -->
                </div>
            </div>
        </div>
        
        <!-- Statistics Content (Hidden by default) -->
        <div id="content-stats" style="display: none;">
            <!-- Settings Profile Management -->
            <div class="mb-6 bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                 <h3 class="text-lg font-semibold text-gray-800 mb-4">ì„¤ì • í”„ë¡œí•„ ê´€ë¦¬</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
                    <div>
                        <label for="profile-select" class="block text-sm font-medium text-gray-700">í”„ë¡œí•„ ì„ íƒ</label>
                        <select id="profile-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div class="flex gap-2">
                         <button id="delete-profile-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition">í”„ë¡œí•„ ì‚­ì œ</button>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t">
                    <label class="block text-sm font-medium text-gray-700">ì•„ì´ì½˜ ì„ íƒ</label>
                    <div id="icon-picker" class="mt-2 flex gap-2 flex-wrap">
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸŒ±</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸ…</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸ“</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸ¥¬</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸ¥•</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸŒ¶ï¸</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸŒ½</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸ†</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸ¥¦</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸ‡</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸ‰</button>
                        <button class="icon-picker-item text-3xl p-2 border-2 rounded-lg transition">ğŸŒ»</button>
                    </div>
                </div>
                <div class="mt-4 border-t pt-4">
                     <label for="profile-name-input" class="block text-sm font-medium text-gray-700">í”„ë¡œí•„ ì´ë¦„</label>
                     <div class="mt-1 flex gap-2">
                        <input type="text" id="profile-name-input" placeholder="ìƒˆ ì´ë¦„ ì…ë ¥ ë˜ëŠ” ê¸°ì¡´ ì´ë¦„ ì„ íƒ" class="flex-grow block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2">
                        <button id="save-profile-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition">ì €ì¥ / ì—…ë°ì´íŠ¸</button>
                     </div>
                </div>
            </div>

             <!-- Sensor Grid -->
             <main class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                 <!-- Temperature Card -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200 flex flex-col items-center justify-between">
                    <div class="w-full flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">ì˜¨ë„</h2>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2> 0 0 1 4 0Z"/></svg>
                    </div>
                    <div class="relative w-40 h-40">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="gauge-circle-bg" cx="50" cy="50" r="45"></circle>
                            <circle id="temp-progress" class="gauge-circle-progress stroke-red-500" cx="50" cy="50" r="45"></circle>
                        </svg>
                        <div id="temp-value" class="absolute inset-0 flex items-center justify-center text-3xl font-bold">--â„ƒ</div>
                    </div>
                    <p class="mt-4 text-gray-500 text-sm">í˜„ì¬ ì‹¤ë‚´ ì˜¨ë„</p>
                </div>

                <!-- Humidity Card (with Controls) -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200 flex flex-col items-center justify-between">
                    <div class="w-full flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">ìŠµë„</h2>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/></svg>
                    </div>
                    <div class="relative w-40 h-40">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="gauge-circle-bg" cx="50" cy="50" r="45"></circle>
                            <circle id="humidity-progress" class="gauge-circle-progress stroke-blue-500" cx="50" cy="50" r="45"></circle>
                        </svg>
                        <div id="humidity-value" class="absolute inset-0 flex items-center justify-center text-3xl font-bold">--%</div>
                    </div>
                     <div class="w-full mt-4">
                        <div class="flex items-center justify-between text-sm py-2">
                            <label for="humidity-input" class="text-gray-600">ëª©í‘œ ìŠµë„</label>
                            <div class="flex items-center gap-1">
                                <input id="humidity-input" type="number" min="0" max="100" class="w-16 text-center font-bold text-blue-600 border border-gray-300 rounded-md p-1 focus:ring-blue-500 focus:border-blue-500">
                                <span class="font-semibold text-gray-500">%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Soil Moisture Card -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200 flex flex-col items-center justify-between">
                    <div class="w-full flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">í† ì–‘ ìˆ˜ë¶„</h2>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><path d="M21.2,12.2C21.2,12.2,21.2,12.2,21.2,12.2C19.3,16,16,18.8,12,18.8S4.7,16,2.8,12.2c0,0,0,0,0,0c-1.8-3.9,0.3-7.5,1-8.6 C4.2,2.8,4.9,2.2,5.6,2.1c0,0,0,0,0.1,0C7.2,1.8,9.6,3.3,12,5.7c2.4-2.4,4.8-3.9,6.3-4.1c0,0,0.1,0,0.1,0c0.7,0.1,1.4,0.7,1.8,1.5 C20.9,4.7,23,8.3,21.2,12.2z"/><path d="M12,18.8v3.3"/></svg>
                    </div>
                    <div class="relative w-40 h-40">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="gauge-circle-bg" cx="50" cy="50" r="45"></circle>
                            <circle id="soil-progress" class="gauge-circle-progress stroke-green-500" cx="50" cy="50" r="45"></circle>
                        </svg>
                        <div id="soil-value" class="absolute inset-0 flex items-center justify-center text-3xl font-bold">--%</div>
                    </div>
                     <div class="w-full mt-4">
                        <div class="flex items-center justify-between text-sm py-2">
                            <label for="soil-input" class="text-gray-600">ê¸‰ìˆ˜ ê¸°ì¤€</label>
                            <div class="flex items-center gap-1">
                                <input id="soil-input" type="number" min="0" max="100" class="w-16 text-center font-bold text-green-600 border border-gray-300 rounded-md p-1 focus:ring-green-500 focus:border-green-500">
                                <span class="font-semibold text-gray-500">%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Light Intensity Card -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200 flex flex-col items-center justify-between">
                    <div class="w-full flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">ì¡°ë„</h2>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m4.93 19.07 1.41-1.41"/><path d="m17.66 6.34 1.41-1.41"/></svg>
                    </div>
                    <div class="relative w-40 h-40">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="gauge-circle-bg" cx="50" cy="50" r="45"></circle>
                            <circle id="light-progress" class="gauge-circle-progress stroke-yellow-500" cx="50" cy="50" r="45"></circle>
                        </svg>
                        <div id="light-value" class="absolute inset-0 flex items-center justify-center text-3xl font-bold">--lx</div>
                    </div>
                    <p class="mt-4 text-gray-500 text-sm">í˜„ì¬ ì¡°ë„ëŸ‰</p>
                </div>
             </main>
             <!-- Chart Grid -->
             <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                 <!-- Temperature Chart -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ì˜¨ë„ ë³€í™” (Â°C)</h3>
                    <div class="h-64"><canvas id="tempChart"></canvas></div>
                </div>
                <!-- Humidity Chart -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ìŠµë„ ë³€í™” (%)</h3>
                    <div class="h-64"><canvas id="humidityChart"></canvas></div>
                </div>
                <!-- Soil Moisture Chart -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">í† ì–‘ ìˆ˜ë¶„ ë³€í™” (%)</h3>
                    <div class="h-64"><canvas id="soilChart"></canvas></div>
                </div>
                <!-- Light Intensity Chart -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ì¡°ë„ ë³€í™” (lx)</h3>
                    <div class="h-64"><canvas id="lightChart"></canvas></div>
                </div>
             </div>
        </div>
    </div>

    <!-- Firebase SDK and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut 
        } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { 
            getFirestore,
            collection,
            doc,
            setDoc,
            deleteDoc,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        // User's Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC4GOpTEhpFMLySLWIKt545mCgRn1M2crU",
            authDomain: "smart-farm-866d9.firebaseapp.com",
            projectId: "smart-farm-866d9",
            storageBucket: "smart-farm-866d9.appspot.com",
            messagingSenderId: "1080160151921",
            appId: "1:1080160151921:web:3180811a31782d6835aed0",
            measurementId: "G-2M1X8VZJVE"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const signupBtn = document.getElementById('signup-btn');
        const authErrorEl = document.getElementById('auth-error');
        const userEmailEl = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const tabControl = document.getElementById('tab-control');
        const tabStats = document.getElementById('tab-stats');
        const contentControl = document.getElementById('content-control');
        const contentStats = document.getElementById('content-stats');
        const tempValueEl = document.getElementById('temp-value');
        const tempProgressEl = document.getElementById('temp-progress');
        const humidityValueEl = document.getElementById('humidity-value');
        const humidityProgressEl = document.getElementById('humidity-progress');
        const soilValueEl = document.getElementById('soil-value');
        const soilProgressEl = document.getElementById('soil-progress');
        const lightValueEl = document.getElementById('light-value');
        const lightProgressEl = document.getElementById('light-progress');
        const humidityInput = document.getElementById('humidity-input');
        const soilInput = document.getElementById('soil-input');
        const connectBtn = document.getElementById('connectBtn');
        const simulateBtn = document.getElementById('simulateBtn');
        const profileSelect = document.getElementById('profile-select');
        const profileNameInput = document.getElementById('profile-name-input');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const deleteProfileBtn = document.getElementById('delete-profile-btn');
        const profileSummaryList = document.getElementById('profile-summary-list');
        const iconPicker = document.getElementById('icon-picker');
        const activePumpCountEl = document.getElementById('active-pump-count');

        // --- State Variables ---
        let currentUserId = null;
        let unsubscribeProfiles = null; 
        let device = null, characteristic = null, isConnected = false, simulationInterval = null;
        let tempChart, humidityChart, soilChart, lightChart;
        let settingsProfiles = {};
        let selectedIcon = 'ğŸŒ±';
        const circumference = 2 * Math.PI * 45;
        let currentTemp = 0.0, currentHumidity = 0, currentSoil = 0, currentLight = 0;
        let targetHumidity = 65, targetSoil = 70;

        // --- Firebase Auth Logic ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                authContainer.style.display = 'none';
                appContainer.style.display = 'block';
                userEmailEl.textContent = user.email;
                listenToProfiles(currentUserId);
            } else {
                currentUserId = null;
                authContainer.style.display = 'flex';
                appContainer.style.display = 'none';
                if (unsubscribeProfiles) unsubscribeProfiles();
                settingsProfiles = {};
                updateProfileSelect();
                updateProfileSummary();
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            authErrorEl.textContent = '';
            signInWithEmailAndPassword(auth, loginEmailInput.value, loginPasswordInput.value)
                .catch(error => {
                    switch(error.code) {
                        case 'auth/user-not-found': authErrorEl.textContent = 'ê°€ì…ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.'; break;
                        case 'auth/wrong-password': authErrorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'; break;
                        default: authErrorEl.textContent = 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                    }
                });
        });

        signupBtn.addEventListener('click', () => {
            authErrorEl.textContent = '';
            if (loginPasswordInput.value.length < 6) { authErrorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'; return; }
            createUserWithEmailAndPassword(auth, loginEmailInput.value, loginPasswordInput.value)
                .catch(error => {
                    switch(error.code) {
                        case 'auth/email-already-in-use': authErrorEl.textContent = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.'; break;
                        case 'auth/invalid-email': authErrorEl.textContent = 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.'; break;
                        default: authErrorEl.textContent = 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                    }
                });
        });

        logoutBtn.addEventListener('click', () => signOut(auth));
        
        // --- Firestore Logic ---
        async function saveProfileToFirestore(profileName, profileData) {
            if (!currentUserId) return;
            await setDoc(doc(db, 'users', currentUserId, 'profiles', profileName), profileData);
        }

        async function deleteProfileFromFirestore(profileName) {
            if (!currentUserId) return;
            await deleteDoc(doc(db, 'users', currentUserId, 'profiles', profileName));
        }
        
        function listenToProfiles(userId) {
            if (unsubscribeProfiles) unsubscribeProfiles();
            unsubscribeProfiles = onSnapshot(collection(db, 'users', userId, 'profiles'), (snapshot) => {
                const newProfiles = {};
                snapshot.forEach(doc => newProfiles[doc.id] = doc.data());
                settingsProfiles = newProfiles;

                if (Object.keys(settingsProfiles).length === 0) {
                     settingsProfiles = { 'ê¸°ë³¸ ì„¤ì •': { icon: 'ğŸŒ±', targetHumidity: 65, targetSoil: 70 } };
                     // Save the default profile for new users
                     saveProfileToFirestore('ê¸°ë³¸ ì„¤ì •', settingsProfiles['ê¸°ë³¸ ì„¤ì •']);
                }
                
                updateProfileSelect();
                const firstProfileName = Object.keys(settingsProfiles)[0];
                if (firstProfileName) {
                    profileSelect.value = firstProfileName;
                    applyProfile(firstProfileName);
                }
                updateProfileSummary();
            });
        }
        
        // --- App Logic ---
        function updateGauge(element, value, max) { const offset = circumference - (value / max) * circumference; element.style.strokeDashoffset = offset; }
        
        function createSensorChart(canvasId, label, color, min, max) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, { type: 'line', data: { labels: [], datasets: [{ label: label, data: [], borderColor: color, backgroundColor: color + '20', tension: 0.4, fill: true, pointBackgroundColor: color, pointRadius: 2, }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { min, max, ticks: { color: '#6b7280' } }, x: { ticks: { color: '#6b7280' } } }, plugins: { legend: { display: false } } } });
        }
        
        function initCharts() { tempChart = createSensorChart('tempChart', 'ì˜¨ë„', '#ef4444', 0, 50); humidityChart = createSensorChart('humidityChart', 'ìŠµë„', '#3b82f6', 0, 100); soilChart = createSensorChart('soilChart', 'í† ì–‘ ìˆ˜ë¶„', '#22c55e', 0, 100); lightChart = createSensorChart('lightChart', 'ì¡°ë„', '#f59e0b', 0, 2000); }
        
        function resetCharts() { [tempChart, humidityChart, soilChart, lightChart].forEach(chart => { if (chart) { chart.data.labels = []; chart.data.datasets[0].data = []; chart.update(); } }); }
        
        function addDataToCharts(temp, humidity, soil, light) {
            const charts = [tempChart, humidityChart, soilChart, lightChart]; const data = [temp, humidity, soil, light];
            const now = new Date(); const timeStr = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0') + ':' + String(now.getSeconds()).padStart(2, '0');
            charts.forEach((chart, index) => { if (!chart) return; const labels = chart.data.labels; labels.push(timeStr); chart.data.datasets[0].data.push(data[index]); if (labels.length > 15) { labels.shift(); chart.data.datasets[0].data.shift(); } chart.update('none'); });
        }

        function updateSensorData(temp, humidity, soil, light) {
            currentTemp = temp; currentHumidity = humidity; currentSoil = soil; currentLight = light;
            tempValueEl.textContent = `${currentTemp.toFixed(1)}â„ƒ`; humidityValueEl.textContent = `${currentHumidity.toFixed(0)}%`; soilValueEl.textContent = `${currentSoil.toFixed(0)}%`; lightValueEl.textContent = `${currentLight.toFixed(0)}lx`;
            updateGauge(tempProgressEl, currentTemp, 50); updateGauge(humidityProgressEl, currentHumidity, 100); updateGauge(soilProgressEl, currentSoil, 100); updateGauge(lightProgressEl, currentLight, 2000);
            updateProfileSummary(); addDataToCharts(temp, humidity, soil, light);
        }

        function updateProfileSummary() {
            if (!profileSummaryList) return; profileSummaryList.innerHTML = ''; let activePumps = 0;
            if (Object.keys(settingsProfiles).length === 0) { profileSummaryList.innerHTML = '<p class="text-gray-500 text-sm col-span-full text-center">ì €ì¥ëœ í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; activePumpCountEl.textContent = '0'; return; }
            for (const profileName in settingsProfiles) {
                const profile = settingsProfiles[profileName]; const isPumpActive = currentSoil < profile.targetSoil; const icon = profile.icon || 'ğŸŒ±'; if (isPumpActive) activePumps++;
                const summaryCard = document.createElement('div');
                summaryCard.className = isPumpActive ? 'bg-white rounded-xl p-4 flex flex-col items-center text-center transition-all shadow-md border-2 border-blue-500' : 'bg-white rounded-xl p-4 flex flex-col items-center text-center transition-all shadow-sm border border-gray-200 hover:shadow-md';
                const statusHTML = isPumpActive ? `<div class="w-full mt-3 px-4 py-2 rounded-lg font-semibold text-sm bg-blue-100 text-blue-800 flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="animate-pulse"><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/></svg><span>ì‘ë™ì¤‘</span></div>` : `<div class="w-full mt-3 px-4 py-2 rounded-lg font-semibold text-sm bg-gray-100 text-gray-600 flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg><span>ëŒ€ê¸°ì¤‘</span></div>`;
                summaryCard.innerHTML = `<div class="text-3xl mb-2">${icon}</div><h4 class="font-bold text-gray-800">${profileName}</h4><p class="text-xs text-gray-500">ê¸‰ìˆ˜ ê¸°ì¤€: <span class="font-semibold">${profile.targetSoil}%</span></p>${statusHTML}`;
                profileSummaryList.appendChild(summaryCard);
            }
            activePumpCountEl.textContent = activePumps; activePumpCountEl.classList.toggle('bg-blue-500', activePumps > 0); activePumpCountEl.classList.toggle('bg-gray-400', activePumps === 0);
        }

        function startSimulation() {
             if (simulationInterval) return; setConnected(true, 'simulation');
             simulationInterval = setInterval(() => { updateSensorData(fluctuate(currentTemp, 10, 40, 0.5), fluctuate(currentHumidity, 20, 90, 1), fluctuate(currentSoil, 10, 80, 0.8), fluctuate(currentLight, 100, 1500, 50)); }, 2000);
        }
        function stopSimulation() { if (simulationInterval) { clearInterval(simulationInterval); simulationInterval = null; } setConnected(false); }
        function fluctuate(value, min, max, amount) { let change = (Math.random() - 0.5) * amount; let newValue = value + change; return Math.max(min, Math.min(max, newValue)); }
        
        function setConnected(state, type = '') {
            isConnected = state;
            simulateBtn.disabled = isConnected && type === 'bluetooth';
            connectBtn.disabled = isConnected && type === 'simulation';
            [simulateBtn, connectBtn].forEach(btn => btn.classList.toggle('opacity-50', btn.disabled));
            [simulateBtn, connectBtn].forEach(btn => btn.classList.toggle('cursor-not-allowed', btn.disabled));

            if (state) {
                const btn = type === 'bluetooth' ? connectBtn : simulateBtn;
                const stopFn = type === 'bluetooth' ? disconnect : stopSimulation;
                btn.innerHTML = type === 'bluetooth' ? `...ì—°ê²° í•´ì œ...` : `...ì‹œë®¬ë ˆì´ì…˜ ì¤‘ì§€...`; // Simplified for brevity
                btn.onclick = stopFn;
                btn.classList.remove('bg-blue-500', 'bg-gray-500');
                btn.classList.add('bg-red-500', 'hover:bg-red-600');
            } else {
                resetCharts();
                connectBtn.innerHTML = `...ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°...`; connectBtn.onclick = connectBluetooth;
                simulateBtn.innerHTML = `...ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘...`; simulateBtn.onclick = startSimulation;
                connectBtn.classList.remove('bg-red-500'); connectBtn.classList.add('bg-blue-500');
                simulateBtn.classList.remove('bg-red-500'); simulateBtn.classList.add('bg-gray-500');
            }
        }

        tabControl.addEventListener('click', () => { contentControl.style.display = 'block'; contentStats.style.display = 'none'; tabControl.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-blue-600 border-blue-600'; tabStats.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent'; });
        tabStats.addEventListener('click', () => { contentStats.style.display = 'block'; contentControl.style.display = 'none'; tabStats.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-blue-600 border-blue-600'; tabControl.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent'; });
        
        function updateProfileSelect() {
            const currentSelection = profileSelect.value; profileSelect.innerHTML = '';
            for (const profileName in settingsProfiles) { const option = document.createElement('option'); option.value = profileName; option.textContent = profileName; profileSelect.appendChild(option); }
            if (settingsProfiles[currentSelection]) { profileSelect.value = currentSelection; }
            deleteProfileBtn.disabled = Object.keys(settingsProfiles).length <= 1; deleteProfileBtn.classList.toggle('opacity-50', deleteProfileBtn.disabled); deleteProfileBtn.classList.toggle('cursor-not-allowed', deleteProfileBtn.disabled);
        }
        function selectIcon(icon) { selectedIcon = icon; document.querySelectorAll('.icon-picker-item').forEach(item => { item.classList.remove('selected'); if (item.textContent === icon) { item.classList.add('selected'); } }); }
        function applyProfile(profileName) {
            if (settingsProfiles[profileName]) {
                const profile = settingsProfiles[profileName];
                targetHumidity = profile.targetHumidity; targetSoil = profile.targetSoil;
                humidityInput.value = targetHumidity; soilInput.value = targetSoil;
                profileNameInput.value = profileName; selectIcon(profile.icon || 'ğŸŒ±'); updateProfileSummary();
            }
        }
        saveProfileBtn.addEventListener('click', () => {
            const profileName = profileNameInput.value.trim(); if (!profileName) { profileNameInput.focus(); return; }
            const profileData = { icon: selectedIcon, targetHumidity: parseInt(humidityInput.value), targetSoil: parseInt(soilInput.value) };
            saveProfileToFirestore(profileName, profileData);
        });
        deleteProfileBtn.addEventListener('click', () => {
            const selectedProfile = profileSelect.value; if (!selectedProfile || Object.keys(settingsProfiles).length <= 1) { return; }
            deleteProfileFromFirestore(selectedProfile);
        });
        profileSelect.addEventListener('change', () => { applyProfile(profileSelect.value); });
        iconPicker.addEventListener('click', (e) => { if (e.target.classList.contains('icon-picker-item')) { selectIcon(e.target.textContent); } });
        humidityInput.addEventListener('change', (e) => { let v=parseInt(e.target.value); v=isNaN(v)?0:Math.max(0,Math.min(100,v)); e.target.value=v; targetHumidity=v; });
        soilInput.addEventListener('change', (e) => { let v=parseInt(e.target.value); v=isNaN(v)?0:Math.max(0,Math.min(100,v)); e.target.value=v; targetSoil=v; updateProfileSummary(); });
        
        initCharts();
        setConnected(false);

        // Expose functions for Firebase module
        window.mainApp = { settingsProfiles, updateProfileSelect, updateProfileSummary, applyProfile, profileSelect };
      })();
    </script>
</body>
</html>

    

